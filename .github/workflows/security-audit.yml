---
name: Enhanced Security Audit

'on':
  push:
    branches: [ main, develop, production ]
  pull_request:
    branches: [ main, develop, production ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        deny-licenses: GPL-2.0, GPL-3.0, AGPL-1.0, AGPL-3.0, LGPL-2.0, LGPL-2.1, LGPL-3.0, EPL-1.0, EPL-2.0, MPL-1.1, MPL-2.0, CDDL-1.0, CDDL-1.1
        comment-summary-in-pr: always

  websocket-security-scan:
    name: WebSocket Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: './GALAX_App_files/package-lock.json'

    - name: Install dependencies
      working-directory: ./GALAX_App_files
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: Check WebSocket Security Implementation
      working-directory: ./GALAX_App_files
      run: |
        echo "üîå Checking WebSocket security implementation..."
        
        # Check for WSS usage
        if grep -r "wss://" . --exclude-dir=node_modules; then
          echo "‚úÖ WSS (Secure WebSocket) implementation found"
        else
          echo "‚ùå WARNING: No WSS implementation detected - using insecure WebSocket"
          exit 1
        fi
        
        # Check for rate limiting
        if grep -r "rate.limit\|express-rate-limit" server/ || grep -r "checkConnectionRateLimit\|checkMessageRateLimit" server/; then
          echo "‚úÖ Rate limiting implementation found"
        else
          echo "‚ö†Ô∏è Limited rate limiting implementation detected"
        fi
        
        # Check for input validation
        if grep -r "validateMessage\|sanitize" server/; then
          echo "‚úÖ Input validation and sanitization found"
        else
          echo "‚ùå WARNING: Limited input validation detected"
          exit 1
        fi

  ai-security-scan:
    name: AI/MCP Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: './GALAX_App_files/package-lock.json'

    - name: Install dependencies
      working-directory: ./GALAX_App_files
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: Check AI Security Controls
      working-directory: ./GALAX_App_files
      run: |
        echo "ü§ñ Checking AI/MCP security implementation..."
        
        # Check for AI security middleware
        if [ -f "server/middleware/ai-security.ts" ]; then
          echo "‚úÖ AI security middleware found"
        else
          echo "‚ùå WARNING: AI security middleware not found"
          exit 1
        fi
        
        # Check for prompt injection protection
        if grep -r "prompt.*inject\|validatePrompt" server/; then
          echo "‚úÖ Prompt injection protection found"
        else
          echo "‚ùå WARNING: No prompt injection protection detected"
          exit 1
        fi

  web3-security-scan:
    name: Web3 Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: './GALAX_App_files/package-lock.json'

    - name: Install dependencies
      working-directory: ./GALAX_App_files
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: Check Web3 Security Implementation
      working-directory: ./GALAX_App_files
      run: |
        echo "üåê Checking Web3 security implementation..."
        
        # Check for Web3 security middleware
        if [ -f "server/middleware/web3-security.ts" ]; then
          echo "‚úÖ Web3 security middleware found"
        else
          echo "‚ùå WARNING: Web3 security middleware not found"
          exit 1
        fi
        
        # Check for post-quantum cryptography
        if grep -r "@noble/post-quantum\|crystals-kyber\|dilithium" . --exclude-dir=node_modules; then
          echo "‚úÖ Post-quantum cryptography libraries found"
        else
          echo "‚ö†Ô∏è No post-quantum cryptography implementation detected"
        fi

  custom-security-audit:
    name: GALAX Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: './GALAX_App_files/package-lock.json'

    - name: Install dependencies
      working-directory: ./GALAX_App_files
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: Run Custom Security Audit
      run: |
        echo "üîí Running GALAX custom security audit..."
        chmod +x ./security/security-audit.sh
        ./security/security-audit.sh

    - name: Upload Security Audit Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: galax-security-audit-report
        path: ./security/reports/
        retention-days: 30

  quantum-readiness-check:
    name: Quantum Readiness Assessment
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Quantum Readiness
      working-directory: ./GALAX_App_files
      run: |
        echo "üîÆ Checking quantum readiness implementation..."
        
        # Check for post-quantum libraries
        if grep -r "@noble/post-quantum\|crystals-kyber\|dilithium-js" package.json; then
          echo "‚úÖ Post-quantum cryptography libraries installed"
        else
          echo "‚ùå WARNING: No post-quantum cryptography libraries found"
          exit 1
        fi

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [websocket-security-scan, ai-security-scan, web3-security-scan, custom-security-audit, quantum-readiness-check]
    if: always()
    timeout-minutes: 5

    steps:
    - name: Security Scan Summary
      run: |
        echo "üîí GALAX Security Scan Summary"
        echo "=============================="
        echo ""
        echo "üîå WebSocket Security: ${{ needs.websocket-security-scan.result }}"
        echo "ü§ñ AI/MCP Security: ${{ needs.ai-security-scan.result }}"
        echo "üåê Web3 Security: ${{ needs.web3-security-scan.result }}"
        echo "üîç Custom Audit: ${{ needs.custom-security-audit.result }}"
        echo "üîÆ Quantum Readiness: ${{ needs.quantum-readiness-check.result }}"
        echo ""
        
        # Check if any critical scans failed
        if [[ "${{ needs.websocket-security-scan.result }}" == "failure" ]] || \
           [[ "${{ needs.ai-security-scan.result }}" == "failure" ]] || \
           [[ "${{ needs.web3-security-scan.result }}" == "failure" ]] || \
           [[ "${{ needs.custom-security-audit.result }}" == "failure" ]]; then
          echo "‚ùå CRITICAL SECURITY ISSUES DETECTED - Review required before deployment"
          exit 1
        else
          echo "‚úÖ All critical security checks passed"
        fi
---
name: "CodeQL"

"on":
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '30 1 * * 2'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if Code Scanning is available
        id: code-scanning-check
        run: |
          # Inline check for Code Scanning availability
          if [ "${{ github.event.repository.private }}" = "false" ]; then
            echo "code_scanning_available=true" >> $GITHUB_OUTPUT
          else
            # For private repos, check if Advanced Security is enabled (not directly available, so default to false)
            echo "code_scanning_available=false" >> $GITHUB_OUTPUT
          fi
      - name: Initialize CodeQL (if available)
        if: steps.code-scanning-check.outputs.code_scanning_available == 'true'
        uses: github/codeql-action/init@v3
        continue-on-error: true
        id: codeql-init
        with:
          languages: ${{ matrix.language }}

      - name: Handle CodeQL unavailable
        if: steps.codeql-init.outcome == 'failure'
        run: |
          echo "⚠️ CodeQL Analysis is not available for this repository."
          echo "This feature requires GitHub Advanced Security for private repositories."
          echo "Consider enabling GitHub Advanced Security or making the repository public to use this feature."
          exit 0

      - name: Setup Node.js
        if: steps.code-scanning-check.outputs.code_scanning_available == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './GALAX_App_files/package-lock.json'

      - name: Install dependencies
        if: steps.code-scanning-check.outputs.code_scanning_available == 'true'
        working-directory: ./GALAX_App_files
        run: |
          if [ ! -d "node_modules" ]; then
            if [ -f "package-lock.json" ]; then
              npm ci --prefer-offline --no-audit --no-fund
            else
              npm install --prefer-offline --no-audit --no-fund
            fi
          fi

      - name: Build application
        if: steps.code-scanning-check.outputs.code_scanning_available == 'true'
        working-directory: ./GALAX_App_files
        run: npm run build

      - name: Perform CodeQL Analysis
        if: steps.code-scanning-check.outputs.code_scanning_available == 'true'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

      - name: CodeQL Not Available Notice
        if: steps.code-scanning-check.outputs.code_scanning_available == 'false'
        run: |
          echo "==================================================================================="
          echo "⚠️  CodeQL Analysis Skipped"
          echo "==================================================================================="
          echo ""
          echo "CodeQL analysis is not available for this repository because:"
          echo "  • Code scanning is not enabled in repository settings"
          echo "  • For private repositories, GitHub Advanced Security is required"
          echo ""
          echo "To enable CodeQL analysis:"
          echo "  1. Go to repository Settings → Security & analysis"
          echo "  2. Enable 'Code scanning alerts'"
          echo "  3. For private repos: Enable 'GitHub Advanced Security'"
          echo ""
          echo "Repository settings: https://github.com/${{ github.repository }}/settings/security_analysis"
          echo "Documentation: https://docs.github.com/en/code-security/code-scanning"
          echo ""
          echo "Alternative security analysis is available in the Security Scan workflow."
          echo "==================================================================================="

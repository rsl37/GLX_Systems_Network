---
name: "CodeQL"

"on":
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '30 1 * * 2'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["javascript"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql-config.yml

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        working-directory: ./GALAX_App_files
        run: |
          if [ ! -d "node_modules" ]; then
            npm ci --prefer-offline --no-audit --no-fund
          fi

      - name: Build application
        working-directory: ./GALAX_App_files
        run: npm run build

      - name: Perform CodeQL Analysis
        id: codeql-analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"
        continue-on-error: true

      - name: Check CodeQL Analysis Status
        if: steps.codeql-analysis.outcome == 'failure'
        run: |
          echo "⚠️ CodeQL analysis failed. This might be because:"
          echo "1. Code scanning is not enabled in repository settings"
          echo "2. There are no security-events permissions"
          echo "3. The repository is private and doesn't have GitHub Advanced Security"
          echo ""
          echo "To fix this:"
          echo "1. Go to repository Settings → Security & analysis"
          echo "2. Enable 'Code scanning' and 'Secret scanning'"
          echo "3. Or contact repository admin to enable GitHub Advanced Security"
          echo ""
          echo "CodeQL analysis completed but results could not be uploaded to GitHub."

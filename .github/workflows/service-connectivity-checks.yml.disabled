---
name: Service Connectivity Checks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run service checks daily at 6 AM UTC to monitor ongoing connectivity
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual triggering for testing service configurations

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'
  WORKING_DIRECTORY: './GLX_App_files'

jobs:
  service-connectivity-tests:
    name: Service Connectivity & Configuration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Ensure cache directories exist
        run: mkdir -p ${{ env.WORKING_DIRECTORY }}/node_modules

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Create test environment file
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üìù Creating test environment configuration..."
          
          # Use test environment if available, otherwise create minimal config
          if [ -f ".env.test" ]; then
            echo "Using existing .env.test file"
            cp .env.test .env
          else
            echo "Creating minimal test environment from .env.example"
            if [ -f ".env.example" ]; then
              cp .env.example .env
            else
              # Create basic environment file for testing
              cat > .env << 'EOF'
          NODE_ENV=test
          PORT=3000
          JWT_SECRET=test-jwt-secret-for-connectivity-testing-minimum-32-characters
          
          # SMTP Configuration (test values)
          SMTP_HOST=smtp.gmail.com
          SMTP_PORT=587
          SMTP_USER=test-email@example.com
          SMTP_PASS=test-password
          SMTP_FROM=noreply@example.com
          
          # Twilio Configuration (test values)
          TWILIO_SID=ACtest12345678901234567890123456
          TWILIO_AUTH_TOKEN=test-auth-token
          TWILIO_PHONE_NUMBER=+1234567890
          
          # Pusher Configuration (test values)
          PUSHER_APP_ID=123456
          PUSHER_KEY=test-key
          PUSHER_SECRET=test-secret
          PUSHER_CLUSTER=us2
          EOF
            fi
          fi

      - name: Run SMTP Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üìß Testing SMTP Configuration..."
          
          # Run service connectivity test focusing on SMTP
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "SMTP\|üìß" || echo "SMTP test completed"

      - name: Run Twilio Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üì± Testing Twilio Configuration..."
          
          # Test Twilio API connectivity and configuration
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "Twilio\|üì±" || echo "Twilio test completed"

      - name: Run Pusher Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîÑ Testing Pusher Configuration..."
          
          # Test Pusher real-time messaging setup
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "Pusher\|üîÑ" || echo "Pusher test completed"

      - name: Run MetaMask/Web3 Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üåê Testing MetaMask/Web3 Configuration..."
          
          # Test Web3 provider connectivity and MetaMask integration setup
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "Web3\|MetaMask\|üåê" || echo "Web3 test completed"

      - name: Run Complete Service Connectivity Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîß Running Complete Service Connectivity Test..."
          
          # Run the complete test suite
          npx tsx scripts/test-service-connectivity.ts

      - name: Validate Service Dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üì¶ Validating Service Dependencies..."
          
          # Check for required service dependencies in package.json
          echo "Checking for SMTP dependencies..."
          if grep -q "nodemailer" package.json; then
            echo "‚úÖ Nodemailer found for SMTP functionality"
          else
            echo "‚ö†Ô∏è No nodemailer dependency found - SMTP functionality may be limited"
          fi
          
          echo "Checking for Twilio dependencies..."
          if grep -q "twilio" package.json; then
            echo "‚úÖ Twilio SDK found"
          else
            echo "‚ö†Ô∏è No Twilio SDK found - SMS functionality may be limited"
          fi
          
          echo "Checking for Pusher dependencies..."
          if grep -q "pusher" package.json; then
            echo "‚úÖ Pusher dependencies found"
            grep "pusher" package.json
          else
            echo "‚ö†Ô∏è No Pusher dependencies found - real-time messaging may be limited"
          fi
          
          echo "Checking for Web3/MetaMask dependencies..."
          if grep -qE "web3|ethers|@noble/post-quantum|crystals-kyber|dilithium" package.json; then
            echo "‚úÖ Web3/Crypto dependencies found"
            grep -E "web3|ethers|@noble/post-quantum|crystals-kyber|dilithium" package.json
          else
            echo "‚ö†Ô∏è Limited Web3 dependencies found"
          fi

      - name: Test Service Integration Points
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîó Testing Service Integration Points..."
          
          # Check for service integration in the codebase
          echo "Checking SMTP integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "nodemailer\|smtp" | grep -v node_modules | head -3; then
            echo "‚úÖ SMTP integration code found"
          else
            echo "‚ö†Ô∏è No SMTP integration code detected"
          fi
          
          echo "Checking Twilio integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "twilio" | grep -v node_modules | head -3; then
            echo "‚úÖ Twilio integration code found"
          else
            echo "‚ö†Ô∏è No Twilio integration code detected"
          fi
          
          echo "Checking Pusher integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "pusher" | grep -v node_modules | head -3; then
            echo "‚úÖ Pusher integration code found"
          else
            echo "‚ö†Ô∏è No Pusher integration code detected"
          fi
          
          echo "Checking Web3/MetaMask integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "web3\|metamask\|ethereum" | grep -v node_modules | head -3; then
            echo "‚úÖ Web3/MetaMask integration code found"
          else
            echo "‚ö†Ô∏è Limited Web3/MetaMask integration detected"
          fi

      - name: Network Connectivity Tests
        run: |
          echo "üåê Testing Network Connectivity to Service Providers..."
          
          # Test connectivity to service provider endpoints
          echo "Testing SMTP providers..."
          for host in smtp.gmail.com smtp-mail.outlook.com smtp.mail.yahoo.com; do
            if timeout 5s bash -c "</dev/tcp/$host/587"; then
              echo "‚úÖ $host:587 reachable"
            else
              echo "‚ö†Ô∏è $host:587 not reachable (may be normal in CI)"
            fi
          done
          
          echo "Testing Twilio API..."
          if curl -s --max-time 5 https://api.twilio.com > /dev/null; then
            echo "‚úÖ Twilio API reachable"
          else
            echo "‚ö†Ô∏è Twilio API not reachable"
          fi
          
          echo "Testing Pusher API..."
          for cluster in us2 us3 eu ap1; do
            if curl -s --max-time 5 https://api-$cluster.pusherapp.com > /dev/null; then
              echo "‚úÖ Pusher $cluster cluster reachable"
              break
            fi
          done
          
          echo "Testing Web3 providers..."
          for provider in ethereum.publicnode.com cloudflare-eth.com; do
            if curl -s --max-time 5 https://$provider > /dev/null; then
              echo "‚úÖ $provider reachable"
            else
              echo "‚ö†Ô∏è $provider not reachable"
            fi
          done

      - name: Service Configuration Security Check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîí Running Service Configuration Security Checks..."
          
          # Check for hardcoded credentials (basic scan)
          echo "Checking for hardcoded service credentials..."
          
          SECRET_FOUND=false
          
          # Check for hardcoded API keys in TypeScript/JavaScript files
          if find . -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" | \
             xargs grep -l "api[_-]key\|secret[_-]key\|auth[_-]token" | \
             grep -v node_modules | grep -v test | grep -v ".env"; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded API keys found in source files"
            SECRET_FOUND=true
          fi
          
          # Check for Twilio credentials
          if find . -name "*.ts" -o -name "*.js" | \
             xargs grep -E "AC[a-z0-9]{32}" | \
             grep -v node_modules | grep -v test | grep -v ".env"; then
            echo "‚ö†Ô∏è Warning: Potential Twilio SID found in source files"
            SECRET_FOUND=true
          fi
          
          # Check for email credentials
          if find . -name "*.ts" -o -name "*.js" | \
             xargs grep -E "smtp.*password|email.*pass" | \
             grep -v node_modules | grep -v test | grep -v ".env"; then
            echo "‚ö†Ô∏è Warning: Potential email credentials found in source files"
            SECRET_FOUND=true
          fi
          
          if [ "$SECRET_FOUND" = false ]; then
            echo "‚úÖ No obvious hardcoded service credentials detected"
          else
            echo "‚ùå Security issue: Hardcoded credentials detected"
            echo "Please move all service credentials to environment variables"
            exit 1
          fi

  service-connectivity-summary:
    name: Service Connectivity Summary
    runs-on: ubuntu-latest
    needs: service-connectivity-tests
    if: always()
    timeout-minutes: 5

    steps:
      - name: Service Connectivity Summary
        run: |
          echo "üîß Service Connectivity Tests Summary"
          echo "======================================"
          echo ""
          echo "üìß SMTP Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo "üì± Twilio Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo "üîÑ Pusher Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo "üåê MetaMask/Web3 Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo ""
          
          if [[ "${{ needs.service-connectivity-tests.result }}" == "failure" ]]; then
            echo "‚ùå CRITICAL SERVICE ISSUES DETECTED"
            echo ""
            echo "One or more essential services have configuration problems:"
            echo "‚Ä¢ Check SMTP settings for email functionality"
            echo "‚Ä¢ Verify Twilio credentials for SMS/phone verification"
            echo "‚Ä¢ Validate Pusher configuration for real-time messaging"
            echo "‚Ä¢ Review Web3 setup for blockchain functionality"
            echo ""
            echo "Please review the detailed logs above and fix any issues before deployment."
            exit 1
          elif [[ "${{ needs.service-connectivity-tests.result }}" == "success" ]]; then
            echo "‚úÖ ALL SERVICE CONNECTIVITY CHECKS PASSED"
            echo ""
            echo "All essential services are properly configured:"
            echo "‚Ä¢ SMTP: Ready for email functionality"
            echo "‚Ä¢ Twilio: Ready for SMS/phone verification"
            echo "‚Ä¢ Pusher: Ready for real-time messaging"
            echo "‚Ä¢ Web3/MetaMask: Ready for blockchain functionality"
            echo ""
            echo "Your application is ready for deployment with full service support."
          else
            echo "‚ö†Ô∏è SERVICE CONNECTIVITY TESTS SKIPPED OR CANCELLED"
            echo "Please check the workflow configuration and try again."
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = "${{ needs.service-connectivity-tests.result }}";
            let commentBody;

            if (testResult === "success") {
              commentBody = `## ‚úÖ Service Connectivity Checks Passed

            All essential services are properly configured and reachable:

            - üìß **SMTP**: Email functionality ready
            - üì± **Twilio**: SMS/phone verification ready  
            - üîÑ **Pusher**: Real-time messaging ready
            - üåê **Web3/MetaMask**: Blockchain functionality ready

            Your application is ready for deployment with full service support.`;
            } else if (testResult === "failure") {
              commentBody = `## ‚ùå Service Connectivity Issues Detected

            One or more essential services have configuration problems. Please review:

            - üìß **SMTP**: Check email configuration
            - üì± **Twilio**: Verify SMS/phone credentials
            - üîÑ **Pusher**: Validate real-time messaging setup
            - üåê **Web3/MetaMask**: Review blockchain connectivity

            See the workflow logs for detailed information about specific issues.`;
            } else {
              commentBody = `## ‚ö†Ô∏è Service Connectivity Tests Inconclusive

            The service connectivity tests did not complete successfully. Please check the workflow logs for more information.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
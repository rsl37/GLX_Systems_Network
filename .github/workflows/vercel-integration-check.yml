---
name: Vercel Integration Check

on:
  pull_request:
    branches: [main]
    paths:
      - 'vercel.json'
      - '.github/workflows/**'
      - 'GLX_App_files/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  statuses: write

env:
  NODE_VERSION: '20.x'
  WORKING_DIRECTORY: './GLX_App_files'

jobs:
  validate-vercel-config:
    name: Validate Vercel Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Validate vercel.json configuration
        run: |
          echo "ðŸ” Validating Vercel configuration..."

          # Check if vercel.json exists
          if [ ! -f "vercel.json" ]; then
            echo "âŒ vercel.json not found"
            exit 1
          fi

          # Validate JSON syntax
          if ! jq . vercel.json > /dev/null 2>&1; then
            echo "âŒ Invalid JSON syntax in vercel.json"
            exit 1
          fi

          # Check required fields
          echo "Checking required Vercel configuration fields..."

          # Build command
          if ! jq -e '.buildCommand' vercel.json > /dev/null; then
            echo "âŒ buildCommand not specified in vercel.json"
            exit 1
          fi

          # Output directory
          if ! jq -e '.outputDirectory' vercel.json > /dev/null; then
            echo "âŒ outputDirectory not specified in vercel.json"
            exit 1
          fi

          # Security headers
          if ! jq -e '.headers' vercel.json > /dev/null; then
            echo "âš ï¸  No security headers configured"
          else
            echo "âœ… Security headers found"

            # Check for essential security headers
            HEADERS=$(jq -r '.headers[0].headers[]?.key' vercel.json 2>/dev/null | tr '\n' ' ')

            if [[ "$HEADERS" =~ "Strict-Transport-Security" ]]; then
              echo "âœ… HSTS header configured"
            else
              echo "âš ï¸  HSTS header missing"
            fi

            if [[ "$HEADERS" =~ "Content-Security-Policy" ]]; then
              echo "âœ… CSP header configured"
            else
              echo "âš ï¸  CSP header missing"
            fi

            if [[ "$HEADERS" =~ "X-Frame-Options" ]]; then
              echo "âœ… X-Frame-Options header configured"
            else
              echo "âš ï¸  X-Frame-Options header missing"
            fi
          fi

          echo "âœ… Vercel configuration validation completed"

      - name: Check environment variable configuration
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ” Checking environment variable configuration..."

          # Check if .env.example exists
          if [ ! -f ".env.example" ]; then
            echo "âš ï¸  .env.example not found"
          else
            echo "âœ… .env.example found"

            # Check for essential environment variables
            ENV_VARS=("NODE_ENV" "JWT_SECRET" "CLIENT_ORIGIN" "DATABASE_URL")

            for var in "${ENV_VARS[@]}"; do
              if grep -q "^$var=" .env.example; then
                echo "âœ… $var is documented in .env.example"
              else
                echo "âš ï¸  $var not found in .env.example"
              fi
            done
          fi

          # Check for .env.vercel
          if [ ! -f ".env.vercel" ]; then
            echo "âš ï¸  .env.vercel not found"
          else
            echo "âœ… .env.vercel found for Vercel deployment guidance"
          fi

  test-build-for-vercel:
    name: Test Build for Vercel Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Test Vercel build configuration
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ—ï¸ Testing build with Vercel configuration..."

          # Simulate Vercel build process
          BUILD_CMD=$(jq -r '.buildCommand' ../vercel.json)
          OUTPUT_DIR=$(jq -r '.outputDirectory' ../vercel.json)

          echo "Build command: $BUILD_CMD"
          echo "Output directory: $OUTPUT_DIR"

          # Change to correct directory and run build
          cd ..
          eval "$BUILD_CMD"

          # Check if output directory exists and has content
          if [ ! -d "$OUTPUT_DIR" ]; then
            echo "âŒ Output directory $OUTPUT_DIR does not exist"
            exit 1
          fi

          if [ ! -f "$OUTPUT_DIR/index.html" ]; then
            echo "âŒ index.html not found in output directory"
            exit 1
          fi

          echo "âœ… Build output validation successful"

          # Check bundle sizes
          echo "ðŸ“Š Analyzing bundle sizes..."
          if [ -d "$OUTPUT_DIR/assets" ]; then
            find "$OUTPUT_DIR/assets" -name "*.js" -exec ls -lh {} \; | \
              awk '{print $5 " " $9}' | sort -hr | head -10

            # Check for oversized bundles
            LARGE_FILES=$(find "$OUTPUT_DIR/assets" -name "*.js" -size +1M)
            if [ -n "$LARGE_FILES" ]; then
              echo "âš ï¸  Large JavaScript bundles detected (>1MB):"
              echo "$LARGE_FILES"
            else
              echo "âœ… All JavaScript bundles are within reasonable size limits"
            fi
          fi

  validate-deployment-secrets:
    name: Validate Deployment Secrets Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Vercel secrets configuration
        run: |
          echo "ðŸ” Checking Vercel deployment configuration..."

          # Check if workflows reference Vercel secrets
          WORKFLOWS_WITH_VERCEL=$(grep -r "VERCEL_TOKEN\|VERCEL_ORG_ID\|VERCEL_PROJECT_ID" .github/workflows/ | cut -d: -f1 | sort -u)

          if [ -n "$WORKFLOWS_WITH_VERCEL" ]; then
            echo "âœ… Found workflows with Vercel integration:"
            echo "$WORKFLOWS_WITH_VERCEL"
          else
            echo "âš ï¸  No workflows found with Vercel integration"
          fi

          # Check preview deployment workflow
          if [ -f ".github/workflows/preview-deploy.yml" ]; then
            echo "âœ… Preview deployment workflow exists"

            # Check if it has proper conditional deployment
            if grep -q "if: env.VERCEL_TOKEN != ''" .github/workflows/preview-deploy.yml; then
              echo "âœ… Preview deployment has proper secret checking"
            else
              echo "âš ï¸  Preview deployment may not have proper secret validation"
            fi
          else
            echo "âš ï¸  Preview deployment workflow not found"
          fi

          # Check production deployment workflow
          if [ -f ".github/workflows/release.yml" ]; then
            echo "âœ… Production release workflow exists"

            if grep -q "VERCEL_TOKEN" .github/workflows/release.yml; then
              echo "âœ… Production deployment includes Vercel integration"
            else
              echo "âš ï¸  Production deployment may not include Vercel integration"
            fi
          else
            echo "âš ï¸  Production release workflow not found"
          fi

  security-headers-validation:
    name: Validate Security Headers Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate security headers
        run: |
          echo "ðŸ”’ Validating security headers configuration..."

          if [ ! -f "vercel.json" ]; then
            echo "âŒ vercel.json not found"
            exit 1
          fi

          # Extract and analyze headers
          echo "Checking configured security headers:"

          # CSP validation
          CSP=$(jq -r '.headers[].headers[]? | select(.key == "Content-Security-Policy") | .value' vercel.json 2>/dev/null)
          if [ -n "$CSP" ]; then
            echo "âœ… Content-Security-Policy configured"

            # Check for common CSP directives
            if [[ "$CSP" =~ "default-src" ]]; then
              echo "  âœ… default-src directive present"
            else
              echo "  âš ï¸  default-src directive missing"
            fi

            if [[ "$CSP" =~ "script-src" ]]; then
              echo "  âœ… script-src directive present"
            else
              echo "  âš ï¸  script-src directive missing"
            fi

            if [[ "$CSP" =~ "style-src" ]]; then
              echo "  âœ… style-src directive present"
            else
              echo "  âš ï¸  style-src directive missing"
            fi
          else
            echo "âŒ Content-Security-Policy not configured"
          fi

          # HSTS validation
          HSTS=$(jq -r '.headers[].headers[]? | select(.key == "Strict-Transport-Security") | .value' vercel.json 2>/dev/null)
          if [ -n "$HSTS" ]; then
            echo "âœ… HSTS configured: $HSTS"

            if [[ "$HSTS" =~ "max-age=" ]]; then
              echo "  âœ… max-age directive present"
            else
              echo "  âš ï¸  max-age directive missing"
            fi

            if [[ "$HSTS" =~ "includeSubDomains" ]]; then
              echo "  âœ… includeSubDomains directive present"
            else
              echo "  âš ï¸  includeSubDomains directive missing"
            fi
          else
            echo "âŒ HSTS not configured"
          fi

          # X-Frame-Options validation
          FRAME_OPTIONS=$(jq -r '.headers[].headers[]? | select(.key == "X-Frame-Options") | .value' vercel.json 2>/dev/null)
          if [ -n "$FRAME_OPTIONS" ]; then
            echo "âœ… X-Frame-Options configured: $FRAME_OPTIONS"
          else
            echo "âŒ X-Frame-Options not configured"
          fi

  integration-test:
    name: Integration Test for Vercel Deployment
    runs-on: ubuntu-latest
    needs: [validate-vercel-config, test-build-for-vercel]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Run deployment readiness tests
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "ðŸ§ª Running deployment readiness tests..."

          # Check if deployment test script exists
          if grep -q '"deployment:check"' package.json; then
            echo "Running deployment check script..."
            npm run deployment:check || echo "Deployment check completed with warnings"
          else
            echo "No deployment check script found"
          fi

          # Basic API endpoint test
          if [ -f "scripts/test-api-endpoints.ts" ] || [ -f "scripts/test-api-endpoints.js" ]; then
            echo "Running API endpoint tests..."
            npm run test:api || echo "API tests completed with warnings"
          fi

      - name: Generate integration report
        if: always()
        run: |
          echo "ðŸ“‹ Integration Check Summary"
          echo "=========================="
          echo "âœ… Vercel configuration validated"
          echo "âœ… Build process tested"
          echo "âœ… Security headers checked"
          echo "âœ… Environment variables validated"
          echo ""
          echo "ðŸŽ¯ Ready for Vercel deployment"

  report-status:
    name: Report Vercel Integration Status
    runs-on: ubuntu-latest
    if: always()
    needs: [validate-vercel-config, test-build-for-vercel, validate-deployment-secrets, security-headers-validation, integration-test]

    steps:
      - name: Report overall status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'validate-vercel-config', result: '${{ needs.validate-vercel-config.result }}' },
              { name: 'test-build-for-vercel', result: '${{ needs.test-build-for-vercel.result }}' },
              { name: 'validate-deployment-secrets', result: '${{ needs.validate-deployment-secrets.result }}' },
              { name: 'security-headers-validation', result: '${{ needs.security-headers-validation.result }}' },
              { name: 'integration-test', result: '${{ needs.integration-test.result }}' }
            ];

            const failed = jobs.filter(job => job.result === 'failure');
            const successful = jobs.filter(job => job.result === 'success');

            let status = 'success';
            let description = `Vercel integration validated (${successful.length}/${jobs.length} checks passed)`;

            if (failed.length > 0) {
              status = 'failure';
              description = `${failed.length} Vercel integration check(s) failed`;
            }

            console.log(`Vercel Integration Status: ${status}`);
            console.log(`Description: ${description}`);

            if (status === 'failure') {
              core.setFailed(description);
            }

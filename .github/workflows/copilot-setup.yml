# /**
#  * GLX: Connect the World - Civic Networking Platform
#  * 
#  * Copyright (c) 2025 rsl37
#  * Dual-licensed under PolyForm Shield 1.0.0 OR PolyForm Noncommercial 1.0.0
#  * 
#  * âš ï¸  TERMS:
#  * - Commercial use strictly prohibited without written permission from copyright holder
#  * - Forking/derivative works prohibited without written permission
#  * - Violations subject to legal action and damages
#  * 
#  * See LICENSE file in repository root for full terms.
#  * Contact: roselleroberts@pm.me for licensing inquiries
#  */

---
name: Copilot MCP Setup
'on':
  workflow_dispatch:
    inputs:
      setup_type:
        description: 'Type of setup to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - servers_only
          - dependencies_only

permissions:
  contents: read

jobs:
  copilot-mcp-setup:
    runs-on: ubuntu-latest
    environment: copilot
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Ensure cache directories exist
        run: mkdir -p ./GLX_App_files/node_modules

      - name: Install MCP server dependencies
        if: >-
          ${{ github.event.inputs.setup_type == 'full' ||
          github.event.inputs.setup_type == 'dependencies_only' }}
        run: |
          echo "Installing MCP server dependencies..."
          npm install -g @cablate/mcp-google-map
          npm install -g @strangelove-ventures/web3-mcp
          npm install -g @modelcontextprotocol/server-github
          npm install -g @modelcontextprotocol/server-postgres
          npm install -g @modelcontextprotocol/server-email
          npm install -g @modelcontextprotocol/server-analytics

      - name: Setup custom MCP servers
        if: >-
          ${{ github.event.inputs.setup_type == 'full' ||
          github.event.inputs.setup_type == 'servers_only' }}
        run: |
          echo "Setting up custom MCP servers..."

          # Create mcp-servers directory if it doesn't exist
          mkdir -p mcp-servers

          # Install dependencies for custom servers
          cd mcp-servers
          npm init -y
          npm install @modelcontextprotocol/sdk socket.io jsonwebtoken

          # Make server files executable
          chmod +x websocket-server.js
          chmod +x civic-server.js
          chmod +x auth-server.js
          chmod +x social-good-server.js

      - name: Validate MCP configuration
        if: ${{ github.event.inputs.setup_type == 'full' }}
        run: |
          echo "Validating MCP configuration..."

          # Check if mcp-config.json exists and is valid JSON
          if [ -f "mcp-config.json" ]; then
            echo "âœ“ MCP configuration file found"
            node -e "JSON.parse(require('fs').readFileSync(
              'mcp-config.json', 'utf8'));
              console.log('âœ“ MCP configuration is valid JSON')"
          else
            echo "âœ— MCP configuration file not found"
            exit 1
          fi

          # Check if custom server files exist
          for server in websocket-server.js civic-server.js \
            auth-server.js social-good-server.js; do
            if [ -f "mcp-servers/$server" ]; then
              echo "âœ“ Custom server found: $server"
            else
              echo "âœ— Custom server missing: $server"
              exit 1
            fi
          done

      - name: Test custom MCP servers
        if: ${{ github.event.inputs.setup_type == 'full' }}
        run: |
          echo "Testing custom MCP servers..."

          cd mcp-servers

          # Basic syntax check for each server
          for server in websocket-server.js civic-server.js \
            auth-server.js social-good-server.js; do
            echo "Testing syntax for $server..."
            node -c "$server"
            echo "âœ“ $server syntax is valid"
          done

      - name: Generate MCP setup report
        if: ${{ github.event.inputs.setup_type == 'full' }}
        run: |
          echo "# MCP Setup Report" > mcp-setup-report.md
          echo "" >> mcp-setup-report.md
          echo "**Setup Date:** $(date)" >> mcp-setup-report.md
          echo "**Setup Type:** ${{ github.event.inputs.setup_type }}" \
            >> mcp-setup-report.md
          echo "" >> mcp-setup-report.md
          echo "## Configuration Files" >> mcp-setup-report.md
          echo "- [x] mcp-config.json" >> mcp-setup-report.md
          echo "" >> mcp-setup-report.md
          echo "## Custom MCP Servers" >> mcp-setup-report.md
          echo "- [x] WebSocket Server (websocket-server.js)" \
            >> mcp-setup-report.md
          echo "- [x] Civic Data Server (civic-server.js)" \
            >> mcp-setup-report.md
          echo "- [x] Authentication Server (auth-server.js)" \
            >> mcp-setup-report.md
          echo "- [x] Social Good Server (social-good-server.js)" \
            >> mcp-setup-report.md
          echo "" >> mcp-setup-report.md
          echo "## External MCP Servers" >> mcp-setup-report.md
          echo "- [x] Google Maps MCP (@cablate/mcp-google-map)" \
            >> mcp-setup-report.md
          echo "- [x] Web3 Blockchain MCP (@strangelove-ventures/web3-mcp)" \
            >> mcp-setup-report.md
          echo "- [x] GitHub Integration MCP \
            (@modelcontextprotocol/server-github)" >> mcp-setup-report.md
          echo "- [x] PostgreSQL MCP (@modelcontextprotocol/server-postgres)" \
            >> mcp-setup-report.md
          echo "- [x] Email MCP (@modelcontextprotocol/server-email)" \
            >> mcp-setup-report.md
          echo "- [x] Analytics MCP (@modelcontextprotocol/server-analytics)" \
            >> mcp-setup-report.md
          echo "" >> mcp-setup-report.md
          echo "## Next Steps" >> mcp-setup-report.md
          echo "1. Configure GitHub Copilot to use the MCP configuration" \
            >> mcp-setup-report.md
          echo "2. Set up environment secrets in the 'copilot' environment" \
            >> mcp-setup-report.md
          echo "3. Test MCP integration with GitHub Copilot" \
            >> mcp-setup-report.md

          echo "Setup report generated:"
          cat mcp-setup-report.md

      - name: Display environment setup instructions
        if: ${{ github.event.inputs.setup_type == 'full' }}
        run: |
          echo "=================================================="
          echo "ðŸš€ MCP SETUP COMPLETE!"
          echo "=================================================="
          echo ""
          echo "ðŸ“‹ REQUIRED GITHUB ENVIRONMENT SECRETS:"
          echo "Add these secrets to your 'copilot' environment:"
          echo ""
          echo "Core Services:"
          echo "  COPILOT_MCP_GOOGLE_MAPS_API_KEY"
          echo "  COPILOT_MCP_GITHUB_TOKEN"
          echo "  COPILOT_MCP_JWT_SECRET"
          echo "  COPILOT_MCP_DATABASE_URL"
          echo ""
          echo "Web3 Integration:"
          echo "  COPILOT_MCP_ETH_PRIVATE_KEY"
          echo ""
          echo "External APIs:"
          echo "  COPILOT_MCP_CIVIC_API_KEY"
          echo "  COPILOT_MCP_OPEN_DATA_KEY"
          echo "  COPILOT_MCP_EMAIL_KEY"
          echo "  COPILOT_MCP_SMS_KEY"
          echo "  COPILOT_MCP_VOLUNTEER_KEY"
          echo "  COPILOT_MCP_CHARITY_KEY"
          echo "  COPILOT_MCP_ANALYTICS_KEY"
          echo ""
          echo "ðŸ”§ NEXT STEPS:"
          echo "1. Go to Settings â†’ Environments â†’ copilot"
          echo "2. Add the required secrets listed above"
          echo "3. Configure GitHub Copilot to use mcp-config.json"
          echo "4. Test MCP integration in GitHub Copilot"
          echo ""
          echo "=================================================="

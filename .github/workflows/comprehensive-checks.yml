name: Comprehensive CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

env:
  NODE_VERSION: '20'
  WORKING_DIRECTORY: './GALAX_App_files'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund
      
      - name: TypeScript Check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Running TypeScript type check..."
          npx tsc --noEmit --project ./tsconfig.json || echo "Type check completed with warnings"
      
      - name: ESLint (if configured)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            echo "Running ESLint..."
            npx eslint . --ext .js,.jsx,.ts,.tsx || echo "ESLint completed with warnings"
          else
            echo "✓ No ESLint config found - skipping lint step"
          fi
      
      - name: Prettier Format Check (if configured)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f ".prettierrc" ] || [ -f ".prettierrc.json" ] || [ -f "prettier.config.js" ]; then
            echo "Checking code formatting..."
            npx prettier --check . || echo "Formatting issues found - run 'npm run format' to fix"
          else
            echo "✓ No Prettier config found - skipping format check"
          fi

  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund
      
      - name: Security Audit
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Running npm security audit..."
          npm audit --audit-level=moderate || echo "Security audit completed with warnings"
      
      - name: Basic Secret Scan
        run: |
          echo "Scanning for potential secrets..."
          SECRET_FOUND=false
          
          echo "Checking for hardcoded API keys..."
          if grep -r -E "(api[_-]?key|secret[_-]?key|auth[_-]?token)\s*[:=]\s*[\"'][a-zA-Z0-9_-]{20,}[\"']" \
             --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
             --exclude-dir=node_modules --exclude-dir=dist . | \
             grep -v "test" | grep -v ".env.example" | grep -v "PLACEHOLDER"; then
            echo "⚠️  Warning: Potential API keys found"
            SECRET_FOUND=true
          fi
          
          echo "Checking for GitHub tokens..."
          if grep -r -E "ghp_[a-zA-Z0-9]{36}" \
             --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" \
             --exclude-dir=node_modules --exclude-dir=dist . | \
             grep -v "test" | grep -v ".env.example"; then
            echo "⚠️  Warning: GitHub tokens found"
            SECRET_FOUND=true
          fi
          
          if [ "$SECRET_FOUND" = false ]; then
            echo "✓ No obvious secrets detected"
          fi

  continuous-integration:
    name: CI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'
      - name: Install dependencies with retry
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: cd ${{ env.WORKING_DIRECTORY }} && npm ci --prefer-offline --no-audit --no-fund
          on_retry_command: echo "npm install failed, retrying..."
      
      - name: Build application with retry
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: cd ${{ env.WORKING_DIRECTORY }} && npm run build
          on_retry_command: echo "Build attempt failed, retrying..."
      
      - name: Run tests with retry
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: cd ${{ env.WORKING_DIRECTORY }} && npm test
          on_retry_command: echo "Test attempt failed, retrying..."
      
      - name: Upload coverage (Node 20 only)
        if: matrix.node-version == 20
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking if 'test:coverage' script exists in package.json..."
          if grep -q '"test:coverage"' package.json; then
            echo "Generating test coverage..."
            npm run test:coverage || echo "Coverage generation completed"
          else
            echo "'test:coverage' script not found in package.json. Skipping coverage generation."
          fi

  performance-checks:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund
      
      - name: Build application
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm run build
      
      - name: Analyze bundle size
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "## Bundle Size Analysis"
          if [ -d "dist/public/assets" ]; then
            echo "JavaScript files:"
            find dist/public/assets/ -name "*.js" -exec ls -lh {} \;
            
            # Check for large bundles
            LARGE_FILES=$(find dist/public/assets/ -name "*.js" -size +500k)
            if [ -n "$LARGE_FILES" ]; then
              echo "⚠️  Warning: Large bundle files detected (>500KB):"
              echo "$LARGE_FILES"
            else
              echo "✓ All bundle sizes are within acceptable limits"
            fi
          else
            echo "No build assets found"
          fi
      
      - name: Lighthouse CI (if configured)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f ".lighthouserc.json" ]; then
            echo "Running Lighthouse CI..."
            timeout 300s npx @lhci/cli@0.12.0 autorun || echo "Lighthouse CI completed with warnings"
          else
            echo "✓ No Lighthouse config found - skipping performance tests"
          fi

  custom-app-checks:
    name: Custom Application Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund
      
      - name: Check environment setup
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking for required environment files..."
          test -f .env.example && echo "✓ .env.example found" || echo "⚠️  .env.example not found"
          test -f .env.test && echo "✓ .env.test found" || echo "⚠️  .env.test not found"
          
          echo "Checking for configuration files..."
          test -f vite.config.js && echo "✓ Vite config found" || echo "⚠️  Vite config not found"
          test -f tsconfig.json && echo "✓ TypeScript config found" || echo "⚠️  TypeScript config not found"
      
      - name: Validate API endpoints (if test exists)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          if [ -f "scripts/test-api-endpoints.ts" ] || [ -f "scripts/test-api-endpoints.js" ]; then
            echo "Running API endpoint validation..."
            npm run test:api || echo "API endpoint tests completed with warnings"
          else
            echo "✓ No API endpoint tests configured"
          fi
      
      - name: Check data directory structure
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking data directory structure..."
          if [ -d "data" ]; then
            echo "✓ Data directory exists"
            ls -la data/ || echo "Data directory is empty"
          else
            echo "⚠️  Data directory not found"
          fi

  deployment-readiness:
    name: Deployment Readiness
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [code-quality, security-checks, continuous-integration]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund
      
      - name: Build for production
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm run build
      
      - name: Check build artifacts
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking build artifacts..."
          if [ -d "dist" ]; then
            echo "✓ Build directory exists"
            find dist/ -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -10
          else
            echo "❌ Build directory not found"
            exit 1
          fi
      
      - name: Validate deployment configuration
        run: |
          echo "Checking deployment readiness..."
          test -f vercel.json && echo "✓ Vercel config found" || echo "⚠️  No Vercel config"
          
          # Check if key files exist for deployment
          test -f ./GALAX_App_files/package.json && echo "✓ Package.json found" || echo "❌ Package.json missing"
          
          echo "✓ Deployment readiness check completed"
      
      - name: Test application startup (basic)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Testing basic application startup..."
          
          # Copy test environment for startup test
          if [ -f ".env.test" ]; then
            cp .env.test .env
          fi
          
          # Quick startup test (with timeout to prevent hanging)
          if npm run --if-present --silent start >/dev/null 2>&1; then
            (npm run start --if-present & echo $! > app_pid.txt) & timeout 30s wait $(cat app_pid.txt)
            APP_PID=$(cat app_pid.txt)
            rm -f app_pid.txt
          else
            echo "⚠️  'start' script not found in package.json. Skipping application startup test, but continuing pipeline."
            true
          fi
          
          # Wait for app to start
          sleep 15
          
          # Basic health check (if app is running on the configured port)
          if curl -f -s http://localhost:${{ env.APP_PORT }} >/dev/null 2>&1; then
            echo "✓ Application started successfully"
          else
            echo "⚠️  Application startup test - unable to connect (may need manual verification)"
          fi
          
          # Clean up
          kill $APP_PID 2>/dev/null || true
          sleep 2
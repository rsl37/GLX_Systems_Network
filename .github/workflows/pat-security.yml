# /**
#  * GLX: Connect the World - Civic Networking Platform
#  * 
#  * Copyright (c) 2025 rsl37
#  * Licensed under PolyForm Shield License 1.0.0
#  * 
#  * âš ï¸  TERMS:
#  * - Commercial use strictly prohibited without written permission from copyright holder
#  * - Forking/derivative works prohibited without written permission
#  * - Violations subject to legal action and damages
#  * 
#  * See LICENSE file in repository root for full terms.
#  * Contact: roselleroberts@pm.me for licensing inquiries
#  */

# Consolidated PAT Security Workflow
# Merges: pat-security-monitoring.yml, pat-implementation-validation.yml, secure-pat-checkout.yml
# Purpose: All PAT token security operations in a single workflow

name: PAT Security

on:
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/secure-*.yml'
      - '.github/workflows/pat-*.yml'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  pull-requests: write
  security-events: write

jobs:
  # ==========================================================================
  # Job 1: PAT Availability Check
  # ==========================================================================
  token-check:
    name: PAT Token Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      pat_configured: ${{ steps.check.outputs.pat_configured }}
      pat_valid: ${{ steps.validate.outputs.pat_valid }}

    steps:
      - name: Check PAT_TOKEN configuration
        id: check
        run: |
          echo "ðŸ” Checking PAT_TOKEN configuration..."
          if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
            echo "pat_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ PAT_TOKEN is not configured"
            echo "Configure at: https://github.com/${{ github.repository }}/settings/secrets/actions"
          else
            echo "pat_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… PAT_TOKEN is configured"
          fi

      - name: Validate PAT_TOKEN
        id: validate
        if: steps.check.outputs.pat_configured == 'true'
        run: |
          echo "ðŸ” Validating PAT_TOKEN..."
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/user" 2>/dev/null)

          BODY=$(echo "$RESPONSE" | sed -e 's/HTTPSTATUS\:.*//g')
          STATUS=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')

          if [ "$STATUS" -eq 200 ]; then
            echo "pat_valid=true" >> $GITHUB_OUTPUT
            USER=$(echo "$BODY" | jq -r '.login')
            echo "âœ… PAT_TOKEN is valid (user: $USER)"
          else
            echo "pat_valid=false" >> $GITHUB_OUTPUT
            echo "âŒ PAT_TOKEN validation failed (status: $STATUS)"
          fi

  # ==========================================================================
  # Job 2: Workflow Security Audit
  # ==========================================================================
  workflow-audit:
    name: Workflow Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Audit workflow security patterns
        run: |
          echo "ðŸ”’ Auditing workflow security patterns..."

          # Check for security best practices
          echo "Checking for persist-credentials: false..."
          PERSIST_COUNT=$(grep -r "persist-credentials.*false" .github/workflows/ | wc -l)
          echo "  Found $PERSIST_COUNT instances âœ…"

          echo "Checking for explicit permissions..."
          PERM_COUNT=$(grep -r "^permissions:" .github/workflows/ | wc -l)
          echo "  Found $PERM_COUNT workflow permission blocks âœ…"

          echo "Checking for timeout protection..."
          TIMEOUT_COUNT=$(grep -r "timeout-minutes:" .github/workflows/ | wc -l)
          echo "  Found $TIMEOUT_COUNT timeout declarations âœ…"

          echo "Checking for environment protection..."
          ENV_COUNT=$(grep -r "environment:" .github/workflows/ | grep -v "env:" | wc -l)
          echo "  Found $ENV_COUNT environment protections"

      - name: Check for credential exposure
        run: |
          echo "ðŸ” Checking for credential exposure..."

          ISSUES_FOUND=false

          # Check for hardcoded tokens in workflows
          if grep -r -E "ghp_|gho_|ghs_" .github/workflows/ 2>/dev/null | grep -v "secrets\." | head -1; then
            echo "âŒ Hardcoded GitHub token found in workflows"
            ISSUES_FOUND=true
          fi

          # Check for token in echo/log statements
          if grep -r -E "echo.*\$\{\{.*TOKEN" .github/workflows/ 2>/dev/null | grep -v "mask" | head -1; then
            echo "âš ï¸ Potential token exposure in echo statements"
            ISSUES_FOUND=true
          fi

          if [ "$ISSUES_FOUND" = false ]; then
            echo "âœ… No credential exposure detected"
          else
            echo "âŒ Security issues found - please review"
            exit 1
          fi

  # ==========================================================================
  # Job 3: Secure Checkout Test
  # ==========================================================================
  secure-checkout:
    name: Secure Checkout Test
    runs-on: ubuntu-latest
    needs: token-check
    if: needs.token-check.outputs.pat_configured == 'true'
    timeout-minutes: 10

    steps:
      - name: Checkout with PAT_TOKEN
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 1
          persist-credentials: false
        continue-on-error: true
        id: pat-checkout

      - name: Fallback checkout
        if: steps.pat-checkout.outcome == 'failure'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          persist-credentials: false

      - name: Verify checkout
        run: |
          if [ "${{ steps.pat-checkout.outcome }}" == "success" ]; then
            echo "âœ… PAT_TOKEN checkout successful"
          else
            echo "âš ï¸ PAT_TOKEN checkout failed, using GITHUB_TOKEN fallback"
          fi

          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"

      - name: Security validation
        run: |
          echo "ðŸ” Validating repository security..."

          # Check for sensitive files
          if find . -name "*.env" -not -path "./node_modules/*" | grep -v ".env.example" | head -1; then
            echo "âš ï¸ Environment files found in repository"
          else
            echo "âœ… No environment files in repository"
          fi

          # Check for credential files
          if find . -name "*.key" -o -name "*.pem" -o -name "*.p12" 2>/dev/null | head -1; then
            echo "âš ï¸ Credential files detected"
          else
            echo "âœ… No credential files detected"
          fi

  # ==========================================================================
  # Job 4: Security Report
  # ==========================================================================
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [token-check, workflow-audit, secure-checkout]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Generate security report
        run: |
          echo "## ðŸ”’ PAT Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PAT_TOKEN Configured | ${{ needs.token-check.outputs.pat_configured == 'true' && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PAT_TOKEN Valid | ${{ needs.token-check.outputs.pat_valid == 'true' && 'âœ… Yes' || 'âš ï¸ Check Required' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Audit | ${{ needs.workflow-audit.result == 'success' && 'âœ… Passed' || 'âŒ Issues' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secure Checkout | ${{ needs.secure-checkout.result == 'success' && 'âœ… Passed' || needs.secure-checkout.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Rotate PAT_TOKEN every 90 days" >> $GITHUB_STEP_SUMMARY
          echo "- Use fine-grained PATs with minimal permissions" >> $GITHUB_STEP_SUMMARY
          echo "- Monitor token usage in audit logs" >> $GITHUB_STEP_SUMMARY

      - name: Report status
        uses: actions/github-script@v7
        with:
          script: |
            const patConfigured = '${{ needs.token-check.outputs.pat_configured }}' === 'true';
            const patValid = '${{ needs.token-check.outputs.pat_valid }}' === 'true';
            const auditPassed = '${{ needs.workflow-audit.result }}' === 'success';

            console.log('PAT Security Summary:');
            console.log(`- PAT Configured: ${patConfigured}`);
            console.log(`- PAT Valid: ${patValid}`);
            console.log(`- Audit Passed: ${auditPassed}`);

            if (!patConfigured) {
              core.warning('PAT_TOKEN is not configured');
            } else if (!patValid) {
              core.warning('PAT_TOKEN may be expired or invalid');
            }

            if (!auditPassed) {
              core.setFailed('Workflow security audit failed');
            }

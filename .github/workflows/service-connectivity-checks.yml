# /**
#  * GLX: Connect the World - Civic Networking Platform
#  * 
#  * Copyright (c) 2025 rsl37
#  * Licensed under PolyForm Shield License 1.0.0
#  * 
#  * ‚ö†Ô∏è  TERMS:
#  * - Commercial use strictly prohibited without written permission from copyright holder
#  * - Forking/derivative works prohibited without written permission
#  * - Violations subject to legal action and damages
#  * 
#  * See LICENSE file in repository root for full terms.
#  * Contact: roselleroberts@pm.me for licensing inquiries
#  */

---
name: Service Connectivity Checks

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
    # Allow manual triggering for testing service configurations

permissions:
  contents: read
  pull-requests: write

env:
  NODE_VERSION: '20'
  WORKING_DIRECTORY: './GLX_App_files'

jobs:
  service-connectivity-tests:
    name: Service Connectivity & Configuration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Ensure cache directories exist
        run: mkdir -p ${{ env.WORKING_DIRECTORY }}/node_modules

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Create test environment file
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üìù Creating test environment configuration..."

          # Use test environment if available, otherwise create minimal config
          if [ -f ".env.test" ]; then
            echo "Using existing .env.test file"
            cp .env.test .env
          else
            echo "Creating minimal test environment from .env.example"
            if [ -f ".env.example" ]; then
              cp .env.example .env
            else
              # Create basic environment file for testing
              cat > .env << 'EOF'
          NODE_ENV=test
          PORT=3000
          JWT_SECRET=test-jwt-secret-for-connectivity-testing-minimum-32-characters

          # SMTP Configuration (test values)
          SMTP_HOST=smtp.gmail.com
          SMTP_PORT=587
          SMTP_USER=test-email@example.com
          SMTP_PASS=test-password
          SMTP_FROM=noreply@example.com

          # Resgrid Configuration (essential for emergency dispatch)
          RESGRID_API_KEY=test-resgrid-api-key
          RESGRID_API_URL=https://api.resgrid.com

          # Vonage Configuration (replaces Twilio)
          VONAGE_API_KEY=test-vonage-key
          VONAGE_API_SECRET=test-vonage-secret
          VONAGE_APPLICATION_ID=test-app-id

          # Ably Configuration (Socket.io with Ably - replaces Pusher)
          ABLY_API_KEY=test-ably-key:secret
          SOCKETIO_ENABLED=true
          EOF
            fi
          fi

      - name: Run SMTP Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üìß Testing SMTP Configuration..."

          # Run service connectivity test focusing on SMTP
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "SMTP\|üìß" || echo "SMTP test completed"

      - name: Run Resgrid Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üö® Testing Resgrid Configuration (Emergency Dispatch)..."

          # Test Resgrid API connectivity for emergency dispatch
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "Resgrid\|üö®" || echo "Resgrid test completed"

      - name: Run Vonage Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üì± Testing Vonage Configuration..."

          # Test Vonage API connectivity and configuration
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "Vonage\|üì±" || echo "Vonage test completed"

      - name: Run Socket.io/Ably Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîÑ Testing Socket.io with Ably Configuration..."

          # Test Socket.io with Ably real-time messaging setup
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "Socket.io\|Ably\|üîÑ" || echo "Socket.io/Ably test completed"

      - name: Run MetaMask/Web3 Configuration Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üåê Testing MetaMask/Web3 Configuration..."

          # Test Web3 provider connectivity and MetaMask integration setup
          npx tsx scripts/test-service-connectivity.ts 2>&1 | grep -A 10 -B 2 "Web3\|MetaMask\|üåê" || echo "Web3 test completed"

      - name: Run Complete Service Connectivity Test
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîß Running Complete Service Connectivity Test..."

          # Run the complete test suite
          npx tsx scripts/test-service-connectivity.ts

      - name: Validate Service Dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üì¶ Validating Service Dependencies..."

          # Check for required service dependencies in package.json
          echo "Checking for SMTP dependencies..."
          if grep -q "nodemailer" package.json; then
            echo "‚úÖ Nodemailer found for SMTP functionality"
          else
            echo "‚ö†Ô∏è No nodemailer dependency found - SMTP functionality may be limited"
          fi

          echo "Checking for Resgrid dependencies..."
          if grep -qE "resgrid|@resgrid" package.json; then
            echo "‚úÖ Resgrid SDK found for emergency dispatch"
          else
            echo "‚ÑπÔ∏è Resgrid integration uses external/resgrid Core module"
          fi

          echo "Checking for Vonage dependencies..."
          if grep -qE "@vonage|nexmo" package.json; then
            echo "‚úÖ Vonage SDK found"
          else
            echo "‚ö†Ô∏è No Vonage SDK found - SMS/Voice functionality may be limited"
          fi

          echo "Checking for Socket.io and Ably dependencies..."
          if grep -qE "socket.io|ably" package.json; then
            echo "‚úÖ Socket.io/Ably dependencies found"
            grep -E "socket.io|ably" package.json
          else
            echo "‚ö†Ô∏è No Socket.io/Ably dependencies found - real-time messaging may be limited"
          fi

          echo "Checking for Web3/MetaMask dependencies..."
          if grep -qE "web3|ethers|@noble/post-quantum|crystals-kyber|dilithium" package.json; then
            echo "‚úÖ Web3/Crypto dependencies found"
            grep -E "web3|ethers|@noble/post-quantum|crystals-kyber|dilithium" package.json
          else
            echo "‚ö†Ô∏è Limited Web3 dependencies found"
          fi

      - name: Test Service Integration Points
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîó Testing Service Integration Points..."

          # Check for service integration in the codebase
          echo "Checking SMTP integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "nodemailer\|smtp" | grep -v node_modules | head -3; then
            echo "‚úÖ SMTP integration code found"
          else
            echo "‚ö†Ô∏è No SMTP integration code detected"
          fi

          echo "Checking Resgrid integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "resgrid\|Resgrid" | grep -v node_modules | head -3; then
            echo "‚úÖ Resgrid integration code found (emergency dispatch)"
          else
            echo "‚ÑπÔ∏è Resgrid Core available in external/resgrid"
          fi

          echo "Checking Vonage integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "vonage\|nexmo" | grep -v node_modules | head -3; then
            echo "‚úÖ Vonage integration code found"
          else
            echo "‚ö†Ô∏è No Vonage integration code detected"
          fi

          echo "Checking Socket.io/Ably integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "socket.io\|ably" | grep -v node_modules | head -3; then
            echo "‚úÖ Socket.io/Ably integration code found"
          else
            echo "‚ö†Ô∏è No Socket.io/Ably integration code detected"
          fi

          echo "Checking Web3/MetaMask integration..."
          if find . -name "*.ts" -o -name "*.js" | xargs grep -l "web3\|metamask\|ethereum" | grep -v node_modules | head -3; then
            echo "‚úÖ Web3/MetaMask integration code found"
          else
            echo "‚ö†Ô∏è Limited Web3/MetaMask integration detected"
          fi

      - name: Network Connectivity Tests
        run: |
          echo "üåê Testing Network Connectivity to Service Providers..."

          # Test connectivity to service provider endpoints
          echo "Testing SMTP providers..."
          for host in smtp.gmail.com smtp-mail.outlook.com smtp.mail.yahoo.com; do
            if timeout 5s bash -c "</dev/tcp/$host/587"; then
              echo "‚úÖ $host:587 reachable"
            else
              echo "‚ö†Ô∏è $host:587 not reachable (may be normal in CI)"
            fi
          done

          echo "Testing Resgrid API..."
          if curl -s --max-time 5 https://api.resgrid.com > /dev/null; then
            echo "‚úÖ Resgrid API reachable (emergency dispatch)"
          else
            echo "‚ö†Ô∏è Resgrid API not reachable"
          fi

          echo "Testing Vonage API..."
          if curl -s --max-time 5 https://api.nexmo.com > /dev/null; then
            echo "‚úÖ Vonage API reachable"
          else
            echo "‚ö†Ô∏è Vonage API not reachable"
          fi

          echo "Testing Ably API..."
          if curl -s --max-time 5 https://rest.ably.io > /dev/null; then
            echo "‚úÖ Ably API reachable"
          else
            echo "‚ö†Ô∏è Ably API not reachable"
          fi

          echo "Testing Web3 providers..."
          for provider in ethereum.publicnode.com cloudflare-eth.com; do
            if curl -s --max-time 5 https://$provider > /dev/null; then
              echo "‚úÖ $provider reachable"
            else
              echo "‚ö†Ô∏è $provider not reachable"
            fi
          done

      - name: Service Configuration Security Check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîí Running Service Configuration Security Checks..."

          # Check for hardcoded credentials (refined scan that avoids false positives)
          # This check looks for actual credential values, not env var names or interfaces
          # Different services have different key formats, so patterns vary:
          # - General API keys: 20+ alphanumeric chars (long random strings)
          # - Vonage: 8+ chars (shorter API keys)
          # - Ably: Contains colon separator (format: keyname:secret)
          # - Resgrid: 16+ chars
          # - SMTP: Any non-empty password value
          echo "Checking for hardcoded service credentials..."

          SECRET_FOUND=false

          # Check for hardcoded API key VALUES (actual secrets assigned, not env var names)
          # Pattern: looks for assignments of string values that look like API keys (long alphanumeric strings)
          # Excludes: process.env references, string literals containing env var names, interface declarations
          if find . -name "*.ts" -o -name "*.js" -o -name "*.tsx" -o -name "*.jsx" | \
             xargs grep -E "(api[_-]?key|secret[_-]?key|auth[_-]?token)\s*[:=]\s*['\"][a-zA-Z0-9_-]{20,}['\"]" 2>/dev/null | \
             grep -v node_modules | grep -v test | grep -v ".env" | grep -v "process\.env" | grep -v "// " | grep -v "* "; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded API keys found in source files"
            SECRET_FOUND=true
          fi

          # Check for hardcoded Vonage/Nexmo API keys (actual values assigned, not env var references)
          # Vonage API keys are typically 8+ alphanumeric chars; secrets are longer
          # Excludes: string literals containing only env var names (like 'VONAGE_API_KEY')
          if find . -name "*.ts" -o -name "*.js" | \
             xargs grep -E "(vonage|nexmo)[_-]?(api[_-]?)?(key|secret|token)\s*[:=]\s*['\"][a-zA-Z0-9_-]{8,}['\"]" 2>/dev/null | \
             grep -vi "process\.env" | grep -v node_modules | grep -v test | grep -v ".env" | \
             grep -v "// " | grep -vE "'\s*VONAGE_|'\s*NEXMO_" | grep -vE "\"\s*VONAGE_|\"\s*NEXMO_"; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded Vonage/Nexmo credentials found in source files"
            SECRET_FOUND=true
          fi

          # Check for hardcoded Ably API keys (actual values with colon separator typical of Ably keys)
          if find . -name "*.ts" -o -name "*.js" | \
             xargs grep -E "ably[_-]?(api[_-]?)?(key|secret|token)\s*[:=]\s*['\"][a-zA-Z0-9_.-]+:[a-zA-Z0-9_-]+['\"]" 2>/dev/null | \
             grep -vi "process\.env" | grep -v node_modules | grep -v test | grep -v ".env"; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded Ably credentials found in source files"
            SECRET_FOUND=true
          fi

          # Check for hardcoded Resgrid API keys (actual values, not interface names or env var references)
          if find . -name "*.ts" -o -name "*.js" | \
             xargs grep -E "resgrid[_-]?(api[_-]?)?(key|secret|token)\s*[:=]\s*['\"][a-zA-Z0-9_-]{16,}['\"]" 2>/dev/null | \
             grep -vi "process\.env" | grep -v node_modules | grep -v test | grep -v ".env" | \
             grep -v "interface " | grep -v "type "; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded Resgrid credentials found in source files"
            SECRET_FOUND=true
          fi

          # Check for hardcoded SMTP passwords (actual password values, not variable references)
          # Excludes: destructuring patterns, function parameters, process.env
          if find . -name "*.ts" -o -name "*.js" | \
             xargs grep -E "smtp[_-]?pass(word)?\s*[:=]\s*['\"][^'\"]+['\"]" 2>/dev/null | \
             grep -vi "process\.env" | grep -v node_modules | grep -v test | grep -v ".env" | \
             grep -v "const {" | grep -v "let {" | grep -v "req\.body"; then
            echo "‚ö†Ô∏è Warning: Potential hardcoded SMTP credentials found in source files"
            SECRET_FOUND=true
          fi

          if [ "$SECRET_FOUND" = false ]; then
            echo "‚úÖ No obvious hardcoded service credentials detected"
          else
            echo "‚ùå Security issue: Hardcoded credentials detected"
            echo "Please move all service credentials to environment variables"
            exit 1
          fi

  service-connectivity-summary:
    name: Service Connectivity Summary
    runs-on: ubuntu-latest
    needs: service-connectivity-tests
    if: always()
    timeout-minutes: 5

    steps:
      - name: Service Connectivity Summary
        run: |
          echo "üîß Service Connectivity Tests Summary"
          echo "======================================"
          echo ""
          echo "üìß SMTP Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo "üö® Resgrid Configuration (Emergency Dispatch): ${{ needs.service-connectivity-tests.result }}"
          echo "üì± Vonage Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo "üîÑ Socket.io/Ably Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo "üåê MetaMask/Web3 Configuration: ${{ needs.service-connectivity-tests.result }}"
          echo ""

          if [[ "${{ needs.service-connectivity-tests.result }}" == "failure" ]]; then
            echo "‚ùå CRITICAL SERVICE ISSUES DETECTED"
            echo ""
            echo "One or more essential services have configuration problems:"
            echo "‚Ä¢ Check SMTP settings for email functionality"
            echo "‚Ä¢ Verify Resgrid API key for emergency dispatch communication"
            echo "‚Ä¢ Validate Vonage credentials for SMS/Voice"
            echo "‚Ä¢ Check Socket.io/Ably configuration for real-time messaging"
            echo "‚Ä¢ Review Web3 setup for blockchain functionality"
            echo ""
            echo "Please review the detailed logs above and fix any issues before deployment."
            exit 1
          elif [[ "${{ needs.service-connectivity-tests.result }}" == "success" ]]; then
            echo "‚úÖ ALL SERVICE CONNECTIVITY CHECKS PASSED"
            echo ""
            echo "All essential services are properly configured:"
            echo "‚Ä¢ SMTP: Ready for email functionality"
            echo "‚Ä¢ Resgrid: Ready for emergency dispatch communication"
            echo "‚Ä¢ Vonage: Ready for SMS/Voice"
            echo "‚Ä¢ Socket.io/Ably: Ready for real-time messaging"
            echo "‚Ä¢ Web3/MetaMask: Ready for blockchain functionality"
            echo ""
            echo "Your application is ready for deployment with full service support."
          else
            echo "‚ö†Ô∏è SERVICE CONNECTIVITY TESTS SKIPPED OR CANCELLED"
            echo "Please check the workflow configuration and try again."
          fi

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = "${{ needs.service-connectivity-tests.result }}";
            let commentBody;

            if (testResult === "success") {
              commentBody = `## ‚úÖ Service Connectivity Checks Passed

            All essential services are properly configured and reachable:

            - üìß **SMTP**: Email functionality ready
            - üö® **Resgrid**: Emergency dispatch communication ready
            - üì± **Vonage**: SMS/Voice ready
            - üîÑ **Socket.io/Ably**: Real-time messaging ready
            - üåê **Web3/MetaMask**: Blockchain functionality ready

            Your application is ready for deployment with full service support.`;
            } else if (testResult === "failure") {
              commentBody = `## ‚ùå Service Connectivity Issues Detected

            One or more essential services have configuration problems. Please review:

            - üìß **SMTP**: Check email configuration
            - üö® **Resgrid**: Verify emergency dispatch API key
            - üì± **Vonage**: Verify SMS/Voice credentials
            - üîÑ **Socket.io/Ably**: Validate real-time messaging setup
            - üåê **Web3/MetaMask**: Review blockchain connectivity

            See the workflow logs for detailed information about specific issues.`;
            } else {
              commentBody = `## ‚ö†Ô∏è Service Connectivity Tests Inconclusive

            The service connectivity tests did not complete successfully. Please check the workflow logs for more information.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

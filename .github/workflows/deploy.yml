# /**
#  * GLX: Connect the World - Civic Networking Platform
#  * 
#  * Copyright (c) 2025 rsl37
#  * Dual-licensed under PolyForm Shield 1.0.0 OR PolyForm Noncommercial 1.0.0
#  * 
#  * âš ï¸  TERMS:
#  * - Commercial use strictly prohibited without written permission from copyright holder
#  * - Forking/derivative works prohibited without written permission
#  * - Violations subject to legal action and damages
#  * 
#  * See LICENSE file in repository root for full terms.
#  * Contact: roselleroberts@pm.me for licensing inquiries
#  */

# Consolidated Deployment Workflow
# Merges: release.yml, preview-deploy.yml, vercel-integration-check.yml
# Purpose: All deployment operations in a single workflow

name: Deploy

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - 'GLX_App_files/**'
      - 'package.json'
      - 'package-lock.json'
      - 'vercel.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production
      release_type:
        description: 'Release type (for production only)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

env:
  NODE_VERSION: '24.x'
  WORKING_DIRECTORY: './GLX_App_files'

concurrency:
  group: deploy-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: false

jobs:
  # ==========================================================================
  # Job 1: Detect Changes
  # ==========================================================================
  detect-changes:
    name: Detect Deployment Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      needs_deployment: ${{ steps.changes.outputs.app_changes }}
      is_docs_only: ${{ steps.changes.outputs.docs_only }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for deployment-relevant changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            app_changes:
              - 'GLX_App_files/**'
              - 'package.json'
              - 'package-lock.json'
              - 'vercel.json'
              - '!**/*.md'
            docs_only:
              - '**/*.md'
              - 'docs/**'

  # ==========================================================================
  # Job 2: Wait for CI/CD Pipeline (Reuses Build Artifacts)
  # ==========================================================================
  # Note: This job waits for ci-pipeline.yml to complete and reuses its build artifacts
  # This eliminates duplicate builds and tests across workflows
  await-ci:
    name: Await CI/CD Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-changes
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.needs_deployment == 'true'

    steps:
      - name: Wait for CI/CD Pipeline
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'Build and Test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
          allowed-conclusions: success

      - name: CI/CD Pipeline Complete
        run: |
          echo "âœ“ CI/CD Pipeline completed successfully"
          echo "Build artifacts from ci-pipeline.yml will be reused"

  # ==========================================================================
  # Job 3: Build for Manual Deployment (workflow_dispatch only)
  # ==========================================================================
  build-manual:
    name: Build for Manual Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Run tests
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm test

      - name: Build application
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm run build

      - name: Validate Vercel configuration
        run: |
          echo "ğŸ” Validating Vercel configuration..."
          if [ -f "vercel.json" ]; then
            jq . vercel.json > /dev/null || { echo "âŒ Invalid JSON"; exit 1; }
            echo "âœ“ Vercel configuration is valid"
          else
            echo "âš ï¸ No vercel.json found"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: ${{ env.WORKING_DIRECTORY }}/dist/
          retention-days: 7

  # ==========================================================================
  # Job 4: Preview Deployment (PRs)
  # ==========================================================================
  preview-deploy:
    name: Preview Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: await-ci
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts from CI/CD Pipeline
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci-pipeline.yml
          workflow_conclusion: success
          name: build-artifacts
          path: ${{ env.WORKING_DIRECTORY }}/dist/
          commit: ${{ github.event.pull_request.head.sha }}
          check_artifacts: true
          search_artifacts: true
          if_no_artifact_found: fail

      - name: Check Vercel secrets
        id: check-secrets
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "secrets_available=true" >> $GITHUB_OUTPUT
          else
            echo "secrets_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Vercel Preview
        if: steps.check-secrets.outputs.secrets_available == 'true'
        id: vercel-deploy
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm install -g vercel@latest
          PREVIEW_URL=$(vercel deploy \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --yes 2>&1 | tail -1)
          echo "preview-url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "Preview deployed to: $PREVIEW_URL"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Health check preview
        if: steps.vercel-deploy.outputs.preview-url != ''
        run: |
          echo "ğŸ¥ Running health check on preview..."
          sleep 30  # Wait for deployment to stabilize
          PREVIEW_URL="${{ steps.vercel-deploy.outputs.preview-url }}"
          if curl -f -s "$PREVIEW_URL" > /dev/null 2>&1; then
            echo "âœ“ Preview deployment is healthy"
          else
            echo "âš ï¸ Preview may have issues (could be warming up)"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.vercel-deploy.outputs.preview-url }}';
            const secretsAvailable = '${{ steps.check-secrets.outputs.secrets_available }}' === 'true';
            const commitSha = context.sha.substring(0, 7);

            let body;
            if (secretsAvailable && previewUrl) {
              body = `ğŸš€ **Preview Deployment**

            âœ… Preview deployed successfully!

            **ğŸ”— Preview URL:** ${previewUrl}
            **ğŸ“ Commit:** ${commitSha}
            **ğŸŒ¿ Branch:** \`${{ github.head_ref }}\`

            ---
            This preview updates automatically with new commits.`;
            } else {
              body = `ğŸ“¦ **Build Status**

            âœ… Build completed successfully!

            **ğŸ“ Commit:** ${commitSha}
            **ğŸŒ¿ Branch:** \`${{ github.head_ref }}\`

            ---
            *Configure Vercel secrets to enable preview deployments.*`;
            }

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Deployment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ==========================================================================
  # Job 5: Production Deployment (Manual)
  # ==========================================================================
  production-deploy:
    name: Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-manual
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.environment == 'production'

    environment:
      name: production
      url: https://glxcivicnetwork.me

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIRECTORY }}/package-lock.json'

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-output
          path: ${{ env.WORKING_DIRECTORY }}/dist/

      - name: Update version
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm version ${{ github.event.inputs.release_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Generate changelog
        id: changelog
        run: |
          echo "## Changes in v${{ env.NEW_VERSION }}" > CHANGELOG_TEMP.md
          echo "" >> CHANGELOG_TEMP.md

          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --reverse >> CHANGELOG_TEMP.md
          else
            git log -20 --pretty=format:"- %s (%h)" --reverse >> CHANGELOG_TEMP.md
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG_TEMP.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Deploy to Vercel Production
        if: env.VERCEL_TOKEN != ''
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          npm install -g vercel@latest
          vercel deploy --prod \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --yes
          echo "âœ“ Production deployment complete"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Commit version bump
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ${{ env.WORKING_DIRECTORY }}/package.json
          git commit -m "chore: bump version to ${{ env.NEW_VERSION }}"
          git tag "v${{ env.NEW_VERSION }}"
          git push origin main --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: Release v${{ env.NEW_VERSION }}
          body: |
            # Release v${{ env.NEW_VERSION }}

            ${{ steps.changelog.outputs.changelog }}

            ## Deployment

            âœ… Deployed to production: https://glxcivicnetwork.me
          draft: false
          prerelease: false

      - name: Production health check
        run: |
          echo "ğŸ¥ Running production health check..."
          sleep 30
          if curl -f -s https://glxcivicnetwork.me > /dev/null 2>&1; then
            echo "âœ“ Production is healthy"
          else
            echo "âš ï¸ Production may need attention"
          fi

  # ==========================================================================
  # Job 6: Docs-Only Notification
  # ==========================================================================
  docs-only-skip:
    name: Documentation-Only Change
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.needs_deployment == 'false' &&
      needs.detect-changes.outputs.is_docs_only == 'true'
    timeout-minutes: 2

    steps:
      - name: Notify docs-only change
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.sha.substring(0, 7);

            const body = `ğŸ“ **Documentation-Only Change**

            âœ… Only documentation files were modified.

            **ğŸ“ Commit:** ${commitSha}
            **ğŸŒ¿ Branch:** \`${{ github.head_ref }}\`

            ---
            ğŸš€ Deployment skipped - no application code changes.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

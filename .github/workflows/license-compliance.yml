---
name: License Compliance Check

on:
  pull_request:
    branches: [main, develop, production]
  push:
    branches: [main, develop, production]
  schedule:
    # Run weekly license compliance check on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  security-events: write

jobs:
  license-compliance:
    name: Comprehensive License Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for comprehensive scanning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            GLX_App_files/package.json
            GLX_App_files/package-lock.json
            mcp-servers/package.json

      - name: Install license scanning tools
        run: |
          npm install -g license-checker@25.0.1
          npm install -g license-report@6.5.0

      - name: Install project dependencies
        run: |
          # Install root dependencies if any
          if [ -f "package-lock.json" ]; then
            npm ci --prefer-offline --no-audit --no-fund
          fi

          # Install main app dependencies
          cd GLX_App_files
          if [ -f "package-lock.json" ]; then
            npm ci --prefer-offline --no-audit --no-fund
          else
            npm install --prefer-offline --no-audit --no-fund
          fi
          cd ..

          # Install MCP server dependencies if they exist
          if [ -f "mcp-servers/package.json" ]; then
            cd mcp-servers
            npm install --prefer-offline --no-audit --no-fund
            cd ..
          fi

      - name: Run license compliance script
        run: |
          # Make sure script is executable
          chmod +x scripts/license-compliance-check.sh

          # Run the comprehensive license compliance check
          ./scripts/license-compliance-check.sh || \
            echo "License compliance check completed with warnings/errors"

      - name: Upload license compliance artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-compliance-report
          path: |
            license-compliance-reports/
          retention-days: 30

      - name: Check for license violations
        id: license-check
        run: |
          report_file="license-compliance-reports/latest-license-compliance-report.txt"
          if [ -f "$report_file" ]; then
            # Look for actual violation entries, not summary lines
            if grep -q "‚ùå.*INCOMPATIBLE\|‚ùå.*No LICENSE file found\|‚ùå.*License scanning failed" "$report_file"; then
              echo "violations=true" >> $GITHUB_OUTPUT
              echo "License compliance issues found!"
              exit 1
            else
              echo "violations=false" >> $GITHUB_OUTPUT
              echo "License compliance check passed!"
            fi
          else
            echo "violations=unknown" >> $GITHUB_OUTPUT
            echo "Could not determine license compliance status"
            exit 1
          fi

      - name: Create license compliance issue on violations
        if: >
          failure() && steps.license-check.outputs.violations == 'true' &&
          github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';

            try {
              const reportPath = 'license-compliance-reports/latest-license-compliance-report.txt';
              report = fs.readFileSync(reportPath, 'utf8');
            } catch (error) {
              report = 'Could not read license compliance report.';
            }

            const issueBody = `## üö® License Compliance Violations Detected

            The automated license compliance check has detected potential
            license violations or compatibility issues.

            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Date:** ${new Date().toISOString()}

            ### Compliance Report

            \`\`\`
            ${report}
            \`\`\`

            ### Required Actions

            1. **Review License Violations**: Check violations marked with ‚ùå above
            2. **Update Dependencies**: Remove or replace incompatible deps
            3. **Update Documentation**: Ensure THIRD_PARTY_LICENSES.md is current
            4. **API License Review**: Verify external API usage compliance
            5. **Re-run Check**: Trigger this workflow again after fixes

            ### Compatibility Guidelines

            - **GLX App License**: PolyForm Shield License 1.0.0 (restrictive)
            - **Compatible**: MIT, BSD, ISC, Apache-2.0 (for internal use)
            - **Incompatible**: GPL, AGPL, LGPL, EPL, MPL, CDDL family licenses

            This issue was automatically generated by the License Compliance
            workflow.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® License Compliance Violations Detected',
              body: issueBody,
              labels: ['security', 'compliance', 'licenses', 'urgent']
            });

      - name: Comment on PR with license status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = '';
            let hasViolations = false;

            try {
              const reportPath = 'license-compliance-reports/latest-license-compliance-report.txt';
              report = fs.readFileSync(reportPath, 'utf8');
              hasViolations = report.includes('‚ùå');
            } catch (error) {
              const msg = 'Could not read license compliance report. ' +
                          'Please check the workflow logs for details.';
              report = msg;
              hasViolations = true;
            }

            const summary = hasViolations
              ? '‚ùå **License Compliance Issues Found**'
              : '‚úÖ **License Compliance Check Passed**';

            const commentBody = `## üìÑ License Compliance Report

            ${summary}

            <details>
            <summary>üìã View Full Compliance Report</summary>

            \`\`\`
            ${report}
            \`\`\`

            </details>

            ${hasViolations ? `
            ### ‚ö†Ô∏è Action Required
            This PR introduces license compliance issues. Please review and
            resolve before merging.
            ` : `
            ### ‚úÖ All Clear
            No license compliance issues detected in this PR.
            `}

            **Report generated at:** ${new Date().toISOString()}
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

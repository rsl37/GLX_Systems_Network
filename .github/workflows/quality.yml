---
name: Quality & Performance

on:
  push:
    branches: [main, develop]
    paths:
      - 'GLX_App_files/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/quality.yml'
  pull_request:
    branches: [main]
    paths:
      - 'GLX_App_files/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/quality.yml'
  workflow_dispatch:

permissions:
  contents: read
  statuses: write
  checks: write
  pull-requests: write

env:
  NODE_VERSION: '20'
  WORKING_DIRECTORY: './GLX_App_files'
jobs:
  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './GLX_App_files/package.json'

      - name: Install dependencies
        working-directory: ./GLX_App_files
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Run tests with coverage
        working-directory: ./GLX_App_files
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        if: success()
        continue-on-error: true
        with:
          directory: ./GLX_App_files/coverage
          fail_ci_if_error: false

  accessibility-testing:
    name: Accessibility Testing
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './GLX_App_files/package.json'

      - name: Install dependencies
        working-directory: ./GLX_App_files
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Install accessibility testing tools
        working-directory: ./GLX_App_files
        run: |
          npm install --no-save @axe-core/cli axe-playwright
          npx playwright install chromium --with-deps

      - name: Build application
        working-directory: ./GLX_App_files
        run: npm run build

      - name: Start application for testing
        working-directory: ./GLX_App_files
        run: |
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV

          # Wait for app to start
          timeout 60 bash -c 'until curl -f http://localhost:3000; do sleep \
            2; done'

      - name: Run accessibility tests
        working-directory: ./GLX_App_files
        run: |
          echo "Running accessibility tests..."

          # Test main pages for accessibility
          npx axe http://localhost:3000 --reporter json --output-file accessibility-results.json || true

          # Display results
          if [ -f accessibility-results.json ]; then
            echo "Accessibility test results:"
            cat accessibility-results.json | head -50
          fi

      - name: Stop application
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi

      - name: Upload accessibility results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-test-results
          path: ./GLX_App_files/accessibility-results.json
          retention-days: 7

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './GLX_App_files/package.json'

      - name: Install dependencies
        working-directory: ./GLX_App_files
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build application
        working-directory: ./GLX_App_files
        run: npm run build

      - name: Analyze bundle size
        working-directory: ./GLX_App_files
        run: |
          echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY

          if [ -d "dist/public/assets" ]; then
            find dist/public/assets/ -name "*.js" -exec ls -lh {} \; | \
              awk '{print "| " $9 " | " $5 " |"}' >> $GITHUB_STEP_SUMMARY

            # Check for oversized bundles
            LARGE_FILES=$(find dist/public/assets/ -name "*.js" -size +500k)
            if [ -n "$LARGE_FILES" ]; then
              echo "⚠️ Large bundle files detected (>500KB)" \
            >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Performance test
        working-directory: ./GLX_App_files
        run: |
          # Start app for testing
          timeout 30s npm start &
          APP_PID=$!

          # Wait for startup
          sleep 10

          # Basic performance check
          if curl -w "Response time: %{time_total}s\n" -f http://localhost:3000 2>/dev/null; then
            echo "✓ Application responds within reasonable time"
          else
            echo "⚠️ Application may have performance issues"
          fi

          # Cleanup
          kill $APP_PID 2>/dev/null || true

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './GLX_App_files/package.json'

      - name: Install dependencies
        working-directory: ./GLX_App_files
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Install Playwright
        working-directory: ./GLX_App_files
        run: |
          echo "Installing Playwright browsers..."
          npx playwright install chromium --with-deps || {
            echo "Failed to install Chromium browser, trying alternative approach..."
            npx playwright install --with-deps || {
              echo "Browser installation failed, will attempt to run tests without browser binaries"
              exit 0
            }
          }

      - name: Build application
        working-directory: ./GLX_App_files
        run: npm run build

      - name: Setup test environment
        working-directory: ./GLX_App_files
        run: |
          echo "Setting up test environment..."
          # Copy test environment
          cp .env.test .env
          # Ensure data directory exists
          mkdir -p data
          # Create a simple test database
          echo "Test environment setup complete"

      - name: Start application
        working-directory: ./GLX_App_files
        run: |
          echo "Starting application for E2E tests..."
          npm start &
          APP_PID=$!
          echo "APP_PID=$APP_PID" >> $GITHUB_ENV

          echo "Waiting for application to start..."
          # Wait for app to start with better error handling
          for i in {1..30}; do
            if curl -f -s http://localhost:3000 >/dev/null 2>&1; then
              echo "✓ Application started successfully on port 3000"
              break
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done

          # Final check
          if ! curl -f -s http://localhost:3000 >/dev/null 2>&1; then
            echo "❌ Application failed to start properly"
            echo "Checking application logs..."
            jobs
            exit 1
          fi

      - name: Run E2E tests
        working-directory: ./GLX_App_files
        run: |
          echo "Running E2E tests..."

          # Check if browsers are properly installed
          if npx playwright --version >/dev/null 2>&1; then
            echo "✓ Playwright is available"
          else
            echo "❌ Playwright is not available"
            exit 1
          fi

          # Check if test files exist
          if [ ! -d "e2e" ] || [ -z "$(ls -A e2e 2>/dev/null)" ]; then
            echo "⚠️  No E2E tests found in e2e directory, creating basic test..."
            mkdir -p e2e
            cat > e2e/basic-health.spec.ts << 'EOF'
          import { test, expect } from '@playwright/test';

          test('Application health check', async ({ page }) => {
            await page.goto('/');
            await expect(page).toHaveTitle(/GLX|Mimo|Civic/i);
            await page.waitForLoadState('networkidle');
            const body = page.locator('body');
            await expect(body).toBeVisible();
          });
          EOF
          fi

          # Run the tests with better error handling
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            echo "Using existing Playwright configuration..."
            npm run test:e2e || {
              echo "E2E tests failed, checking for common issues..."
              echo "Browser status:"
              npx playwright install --dry-run chromium || true
              exit 1
            }
          else
            echo "No Playwright config found, running with basic setup..."
            npx playwright test --config=playwright.config.ts || {
              echo "E2E tests failed with basic setup"
              exit 1
            }
          fi

          echo "✓ E2E tests completed successfully"

      - name: Stop application
        if: always()
        run: |
          if [ ! -z "$APP_PID" ]; then
            kill $APP_PID || true
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            ./GLX_App_files/test-results/
            ./GLX_App_files/playwright-report/
          retention-days: 7

  # Status reporting job to ensure proper PR status updates
  report-quality-status:
    name: Report Quality & Performance Status
    runs-on: ubuntu-latest
    if: always()
    needs: [code-coverage, accessibility-testing, performance-check, e2e-tests]
    timeout-minutes: 5

    steps:
      - name: Report overall quality status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'code-coverage', result: '${{ needs.code-coverage.result }}' },
              { name: 'accessibility-testing', result: '${{ needs.accessibility-testing.result }}' },
              { name: 'performance-check', result: '${{ needs.performance-check.result }}' },
              { name: 'e2e-tests', result: '${{ needs.e2e-tests.result }}' }
            ];

            const failed = jobs.filter(job => job.result === 'failure');
            const cancelled = jobs.filter(job => job.result === 'cancelled');
            const skipped = jobs.filter(job => job.result === 'skipped');
            const successful = jobs.filter(job => job.result === 'success');

            let status = 'success';
            let description = `All quality checks passed (${successful.length}/${jobs.length})`;

            if (failed.length > 0) {
              status = 'failure';
              description = `${failed.length} quality check(s) failed: ${failed.map(j => j.name).join(', ')}`;
            } else if (cancelled.length > 0) {
              status = 'error';
              description = `${cancelled.length} quality check(s) cancelled: ${cancelled.map(j => j.name).join(', ')}`;
            } else if (skipped.length > 0) {
              status = 'success'; // Treat skipped as neutral success when no failures
              description = `${successful.length} passed, ${skipped.length} skipped (${successful.length + skipped.length}/${jobs.length})`;
            }

            console.log(`Quality & Performance Status: ${status}`);
            console.log(`Description: ${description}`);
            console.log('Job Results:', JSON.stringify(jobs, null, 2));

            // Set overall workflow status
            if (status === 'failure') {
              core.setFailed(description);
            }

      - name: Update commit status for quality checks
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Code Coverage', result: '${{ needs.code-coverage.result }}' },
              { name: 'Accessibility Testing', result: '${{ needs.accessibility-testing.result }}' },
              { name: 'Performance Check', result: '${{ needs.performance-check.result }}' },
              { name: 'End-to-End Tests', result: '${{ needs.e2e-tests.result }}' }
            ];

            for (const job of jobs) {
              let state = 'pending';
              let description = `${job.name}: ${job.result}`;
              
              // Map all possible job results to proper GitHub status states
              switch (job.result) {
                case 'success':
                  state = 'success';
                  break;
                case 'failure':
                  state = 'failure';
                  break;
                case 'cancelled':
                  state = 'error';
                  description = `${job.name}: cancelled`;
                  break;
                case 'skipped':
                  state = 'success'; // Treat skipped as neutral success
                  description = `${job.name}: skipped (conditional)`;
                  break;
                default:
                  state = 'error';
                  description = `${job.name}: ${job.result || 'unknown'}`;
              }
              
              console.log(`Setting status for ${job.name}: ${state} (${job.result})`);
              
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.payload.pull_request.head.sha,
                state: state,
                context: `Quality & Performance / ${job.name}`,
                description: description,
                target_url: `${context.payload.pull_request.html_url}/checks`
              });
            }

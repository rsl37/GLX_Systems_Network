---
name: Release Management

'on':
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of release (patch, minor, major)'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  release:
    name: Automated Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Ensure cache directories exist
        run: mkdir -p ./GLX_App_files/node_modules

      - name: Install dependencies
        working-directory: ./GLX_App_files
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Run tests
        working-directory: ./GLX_App_files
        run: npm test

      - name: Build application
        working-directory: ./GLX_App_files
        run: npm run build

      - name: Determine release type
        id: release-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.release_type }}" \
              >> $GITHUB_OUTPUT
          else
            # Auto-determine based on commit messages
            if git log --format=%B -n 20 | grep -q "BREAKING CHANGE"; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif git log --format=%B -n 20 | grep -qE "^feat(\(.+\))?: "; then
              echo "type=minor" >> $GITHUB_OUTPUT
            else
              echo "type=patch" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # Create changelog based on git commits
          echo "## Changes" > CHANGELOG_TEMP.md
          echo "" >> CHANGELOG_TEMP.md

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            RANGE="$LAST_TAG..HEAD"
          else
            RANGE="HEAD"
          fi

          # Process commits
          git log $RANGE --pretty=format:"- %s (%h)" --reverse \
            >> CHANGELOG_TEMP.md

          # Set output for use in release
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG_TEMP.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update version in package.json
        working-directory: ./GLX_App_files
        run: |
          # Update version based on release type
          npm version ${{ steps.release-type.outputs.type }} \
            --no-git-tag-version

          # Get new version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Commit version bump
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add GLX_App_files/package.json
          git commit -m "chore: bump version to ${{ env.NEW_VERSION }}"
          git tag "v${{ env.NEW_VERSION }}"
          git push origin main --tags

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: Release v${{ env.NEW_VERSION }}
          body: |
            # Release v${{ env.NEW_VERSION }}

            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            ```bash
            git clone https://github.com/rsl37/GLX_Civic_Networking_App.git
            cd GLX_Civic_Networking_App/GLX_App_files
            npm install
            npm run build
            npm start
            ```

            ## Deployment

            This release has been automatically deployed to the production
            environment.

            **Live Demo:** [glxcivicnetwork.me](https://glxcivicnetwork.me)
    draft: false
    prerelease: false

  deploy-production:
  name: Deploy to Production
  runs-on: ubuntu-latest
  needs: [release]
  timeout-minutes: 15
  if: github.ref == 'refs/heads/main'

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: './package-lock.json'

<<<<<<< HEAD
    - name: Ensure cache directories exist
      run: mkdir -p ./GLX_App_files/node_modules
=======
      - name: Ensure cache directories exist
        run: mkdir -p ./GALAX_App_files/node_modules
>>>>>>> origin/all-merged

    - name: Install dependencies
      working-directory: ./GLX_App_files
      run: npm ci --prefer-offline --no-audit --no-fund

    - name: Build for production
      working-directory: ./GLX_App_files
      run: npm run build

    - name: Deploy to Vercel Production
      if: env.VERCEL_TOKEN != ''
      working-directory: ./GLX_App_files
      run: |
        # Install Vercel CLI
        npm install -g vercel@latest

        # Deploy to production
        vercel deploy \
          --prod \
          --token=${{ secrets.VERCEL_TOKEN }} \
          --scope=${{ secrets.VERCEL_ORG_ID }} \
          --project-id=${{ secrets.VERCEL_PROJECT_ID }} \
          --yes

        echo "Production deployment completed"
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    - name: Post-deployment health check
      run: |
        echo "Waiting for deployment to be available..."
        sleep 30

        # Health check
        if curl -f -s https://glxcivicnetwork.me/health 2>/dev/null; then
          echo "‚úÖ Production deployment successful"
        elif curl -f -s https://glxcivicnetwork.me 2>/dev/null; then
          echo "‚úÖ Production deployment successful (main page)"
        else
          echo "‚ö†Ô∏è Production deployment may have issues"
          exit 1
        fi

    - name: Notify deployment status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = process.env.DEPLOYMENT_STATUS || 'unknown';
          const version = process.env.NEW_VERSION || 'unknown';

          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `üöÄ **Production Deployment**\n\n‚úÖ Version ${version} \
              successfully deployed to production!\n\n**Live URL:** \
              https://glxcivicnetwork.me`
          });

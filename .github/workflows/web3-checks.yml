# /**
#  * GLX: Connect the World - Civic Networking Platform
#  * 
#  * Copyright (c) 2025 rsl37
#  * Dual-licensed under PolyForm Shield 1.0.0 OR PolyForm Noncommercial 1.0.0
#  * 
#  * ‚ö†Ô∏è  TERMS:
#  * - Commercial use strictly prohibited without written permission from copyright holder
#  * - Forking/derivative works prohibited without written permission
#  * - Violations subject to legal action and damages
#  * 
#  * See LICENSE file in repository root for full terms.
#  * Contact: roselleroberts@pm.me for licensing inquiries
#  */

---
name: Web3 Functionality & Integration Tests

'on':
  pull_request:
    branches: [main]
    paths:
      - '**/*web3*'
      - '**/*crypto*'
      - '**/*blockchain*'
      - '**/*defi*'
      - 'GLX_App_files/server/middleware/web3-security.ts'
      - 'mcp-config.json'
      - 'GLX_App_files/package.json'
      - 'package.json'
      - '.github/workflows/web3-checks.yml'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run all Web3 checks'
        required: false
        default: 'false'

permissions:
  contents: read
  security-events: write
  pull-requests: write

env:
  NODE_VERSION: '24'
  WORKING_DIRECTORY: './GLX_App_files'

jobs:
  detect-web3-changes:
    name: Detect Web3 Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      has_web3_changes: ${{ steps.changes.outputs.web3 }}
      has_crypto_changes: ${{ steps.changes.outputs.crypto }}
      has_config_changes: ${{ steps.changes.outputs.config }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Web3-related changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            web3:
              - '**/*web3*'
              - '**/*blockchain*'
              - '**/*defi*'
              - 'GLX_App_files/server/middleware/web3-security.ts'
            crypto:
              - '**/*crypto*'
              - '**/*quantum*'
              - '**/*kyber*'
              - '**/*dilithium*'
            config:
              - 'mcp-config.json'
              - 'GLX_App_files/package.json'
              - 'package.json'

  web3-functionality:
    name: Web3 Functionality Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: detect-web3-changes
    if: |
      github.event.inputs.force_run == 'true' ||
      needs.detect-web3-changes.outputs.has_web3_changes == 'true' ||
      needs.detect-web3-changes.outputs.has_crypto_changes == 'true' ||
      needs.detect-web3-changes.outputs.has_config_changes == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Ensure cache directories exist
        run: mkdir -p ${{ env.WORKING_DIRECTORY }}/node_modules

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Check Web3 Dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üåê Checking Web3 dependencies..."
          if grep -q "web3\|ethers\|@web3js\|viem" package.json; then
            echo "‚úÖ Web3 libraries found in dependencies"
            grep -E "web3|ethers|@web3js|viem" package.json
          else
            echo "‚ö†Ô∏è No standard Web3 libraries detected"
          fi
          if grep -q "blockchain\|ethereum\|polygon\|solana" package.json; then
            echo "‚úÖ Blockchain-related dependencies found"
            grep -E "blockchain|ethereum|polygon|solana" package.json
          else
            echo "‚ö†Ô∏è No blockchain-specific dependencies detected"
          fi

      - name: Validate Web3 Configuration
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîß Validating Web3 configuration..."
          if [ -f "src/config/web3.ts" ] || [ -f "src/config/web3.js" ]; then
            echo "‚úÖ Web3 configuration file found"
          else
            echo "‚ö†Ô∏è No dedicated Web3 configuration file found"
          fi
          if grep -r "wallet\|metamask\|connect" src/ \
             --include="*.ts" --include="*.js" --include="*.tsx" \
             --include="*.jsx" 2>/dev/null; then
            echo "‚úÖ Wallet integration code detected"
          else
            echo "‚ö†Ô∏è No wallet integration detected"
          fi

      - name: Test Web3 Provider Connection
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîó Testing Web3 provider connectivity..."
          cat > test-web3-connection.cjs << 'EOF'
          const https = require('https');
          const providers = [
            'eth-mainnet.alchemyapi.io',
            'mainnet.infura.io',
            'ethereum.publicnode.com'
          ];
          console.log('Testing Web3 provider connectivity...');
          providers.forEach(provider => {
            const options = {
              hostname: provider,
              port: 443,
              path: '/',
              method: 'HEAD',
              timeout: 5000
            };
            const req = https.request(options, (res) => {
              console.log(`‚úÖ ${provider}: Reachable (${res.statusCode})`);
            });
            req.on('error', (err) => {
              console.log(`‚ö†Ô∏è ${provider}: Not reachable (${err.message})`);
            });
            req.on('timeout', () => {
              console.log(`‚ö†Ô∏è ${provider}: Timeout`);
              req.destroy();
            });
            req.end();
          });
          setTimeout(() => {
            console.log('Web3 provider connectivity test completed');
          }, 10000);
          EOF
          node test-web3-connection.cjs
          rm test-web3-connection.cjs

      - name: Validate Post-Quantum Cryptography
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîÆ Validating post-quantum cryptography implementation..."
          if grep -q "@noble/post-quantum\|crystals-kyber\|dilithium" package.json; then
            echo "‚úÖ Post-quantum cryptography libraries found"
            grep -E "@noble/post-quantum|crystals-kyber|dilithium" package.json
          else
            echo "‚ö†Ô∏è No post-quantum cryptography libraries found"
          fi

      - name: Test Web3 Security Middleware
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üõ°Ô∏è Testing Web3 security middleware..."
          if [ -f "server/middleware/web3-security.ts" ]; then
            echo "‚úÖ Web3 security middleware found"
            npx tsc --noEmit server/middleware/web3-security.ts 2>/dev/null && \
              echo "‚úÖ Web3 security middleware compiles successfully" || \
              echo "‚ö†Ô∏è Web3 security middleware has compilation issues"
          else
            echo "‚ùå Web3 security middleware not found"
            exit 1
          fi

      - name: Run Web3 Unit Tests (if available)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üß™ Running Web3 unit tests..."
          WEB3_TESTS=$(find . -name "*web3*.test.*" -o -name "*blockchain*.test.*" \
            -o -name "*crypto*.test.*" | grep -v node_modules)
          if [ -n "$WEB3_TESTS" ]; then
            echo "‚úÖ Web3 test files found:"
            echo "$WEB3_TESTS"
            if grep -q '"test:web3"' package.json; then
              npm run test:web3 || echo "Web3 tests completed with warnings"
            else
              npm test -- --grep "web3|blockchain|crypto" || echo "Tests completed"
            fi
          else
            echo "‚ö†Ô∏è No dedicated Web3 test files found"
            npm test || echo "Tests completed"
          fi

  web3-integration:
    name: Web3 Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect-web3-changes, web3-functionality]
    if: |
      github.event.inputs.force_run == 'true' ||
      needs.detect-web3-changes.outputs.has_web3_changes == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Ensure cache directories exist
        run: mkdir -p ${{ env.WORKING_DIRECTORY }}/node_modules

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Build application
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm run build

      - name: Test Web3 MCP Integration
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîó Testing Web3 MCP integration..."
          if [ -f "../mcp-config.json" ]; then
            echo "‚úÖ MCP configuration found"
            if grep -q "web3\|blockchain" ../mcp-config.json; then
              echo "‚úÖ Web3 MCP configuration detected"
              cat ../mcp-config.json | grep -A 5 -B 5 "web3\|blockchain" || true
            else
              echo "‚ö†Ô∏è No Web3 MCP configuration found"
            fi
          else
            echo "‚ö†Ô∏è No MCP configuration file found"
          fi

      - name: Test DeFi Functionality (if available)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üí∞ Testing DeFi functionality..."
          if grep -r "defi\|swap\|liquidity\|yield\|staking" src/ \
             --include="*.ts" --include="*.js" 2>/dev/null; then
            echo "‚úÖ DeFi functionality detected"
            if grep -q '"test:defi"' package.json; then
              npm run test:defi || echo "DeFi tests completed with warnings"
            else
              echo "‚ö†Ô∏è No dedicated DeFi test script found"
            fi
          else
            echo "‚ö†Ô∏è No DeFi functionality detected"
          fi

      - name: Blockchain Network Compatibility Check
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üåê Checking blockchain network compatibility..."
          if grep -r "ethereum\|polygon\|bsc\|avalanche\|arbitrum\|optimism" src/ \
             --include="*.ts" --include="*.js" 2>/dev/null; then
            echo "‚úÖ Multi-chain support detected"
          else
            echo "‚ö†Ô∏è Limited blockchain network support"
          fi
          if grep -r "testnet\|goerli\|sepolia\|mumbai" . \
             --include="*.ts" --include="*.js" --include="*.json" | \
             grep -v node_modules; then
            echo "‚úÖ Testnet configurations found"
          else
            echo "‚ö†Ô∏è No testnet configurations detected"
          fi

  web3-security-validation:
    name: Web3 Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [detect-web3-changes, web3-functionality]
    if: |
      github.event.inputs.force_run == 'true' ||
      needs.detect-web3-changes.outputs.has_web3_changes == 'true' ||
      needs.detect-web3-changes.outputs.has_crypto_changes == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Ensure cache directories exist
        run: mkdir -p ${{ env.WORKING_DIRECTORY }}/node_modules

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: npm ci --prefer-offline --no-audit --no-fund

      - name: Validate Web3 Security Patterns
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üîí Validating Web3 security patterns..."
          if grep -r "nonReentrant\|mutex\|guard" . \
             --include="*.ts" --include="*.js" | grep -v node_modules; then
            echo "‚úÖ Reentrancy protection patterns found"
          else
            echo "‚ö†Ô∏è No reentrancy protection patterns detected"
          fi
          if grep -r "validate.*address\|isValidAddress\|checksum" . \
             --include="*.ts" --include="*.js" | grep -v node_modules; then
            echo "‚úÖ Address validation patterns found"
          else
            echo "‚ö†Ô∏è Limited address validation detected"
          fi
          if grep -r "validate.*amount\|isValidAmount\|BigNumber" . \
             --include="*.ts" --include="*.js" | grep -v node_modules; then
            echo "‚úÖ Amount validation patterns found"
          else
            echo "‚ö†Ô∏è Limited amount validation detected"
          fi

      - name: Check for Common Web3 Vulnerabilities
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "üïµÔ∏è Checking for common Web3 vulnerabilities..."
          UNSAFE_PATTERNS=0
          if grep -r "eval\|Function\|setTimeout.*string" . \
             --include="*.ts" --include="*.js" | \
             grep -v node_modules | grep -v test; then
            echo "‚ö†Ô∏è Potentially unsafe dynamic code execution detected"
            UNSAFE_PATTERNS=$((UNSAFE_PATTERNS + 1))
          fi
          if grep -r "localStorage.*private\|sessionStorage.*key" . \
             --include="*.ts" --include="*.js" | grep -v node_modules; then
            echo "‚ö†Ô∏è Potential private key storage in browser storage"
            UNSAFE_PATTERNS=$((UNSAFE_PATTERNS + 1))
          fi
          if grep -r "http://.*web3\|http://.*rpc" . \
             --include="*.ts" --include="*.js" | grep -v node_modules; then
            echo "‚ö†Ô∏è Insecure HTTP connections to Web3 providers detected"
            UNSAFE_PATTERNS=$((UNSAFE_PATTERNS + 1))
          fi
          if [ $UNSAFE_PATTERNS -eq 0 ]; then
            echo "‚úÖ No obvious Web3 security vulnerabilities detected"
          else
            echo "‚ùå $UNSAFE_PATTERNS potential security issues found"
            exit 1
          fi

  web3-summary:
    name: Web3 Tests Summary
    runs-on: ubuntu-latest
    needs:
      - detect-web3-changes
      - web3-functionality
      - web3-integration
      - web3-security-validation
    if: always() && needs.detect-web3-changes.result != 'skipped'
    timeout-minutes: 5

    steps:
      - name: Web3 Test Summary
        run: |
          echo "üåê Web3 Functionality & Integration Test Summary"
          echo "==============================================="
          echo ""
          echo "üîß Web3 Functionality: ${{ needs.web3-functionality.result }}"
          echo "üîó Web3 Integration: ${{ needs.web3-integration.result }}"
          echo "üîí Web3 Security: ${{ needs.web3-security-validation.result }}"
          echo ""
          if [[ "${{ needs.web3-functionality.result }}" == "failure" ]] || \
             [[ "${{ needs.web3-security-validation.result }}" == "failure" ]]; then
            echo "‚ùå CRITICAL WEB3 ISSUES DETECTED - Review required"
            exit 1
          elif [[ "${{ needs.web3-integration.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è Web3 integration issues detected - review recommended"
            echo "‚úÖ Core Web3 functionality and security checks passed"
          else
            echo "‚úÖ All Web3 checks passed successfully"
          fi

      - name: Upload Web3 test artifacts (if any failures)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web3-test-results
          path: |
            ./GLX_App_files/web3-test-results/
            ./GLX_App_files/coverage/
          retention-days: 7

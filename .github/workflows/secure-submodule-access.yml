# /**
#  * GLX: Connect the World - Civic Networking Platform
#  * 
#  * Copyright (c) 2025 rsl37
#  * Licensed under PolyForm Shield License 1.0.0
#  * 
#  * ‚ö†Ô∏è  TERMS:
#  * - Commercial use strictly prohibited without written permission from copyright holder
#  * - Forking/derivative works prohibited without written permission
#  * - Violations subject to legal action and damages
#  * 
#  * See LICENSE file in repository root for full terms.
#  * Contact: roselleroberts@pm.me for licensing inquiries
#  */

---
name: Secure Submodule Access with PAT_TOKEN

on:
  push:
    branches: [main, develop]
    paths:
      - '.gitmodules'
      - 'Core/**'
      - '.github/workflows/secure-submodule-access.yml'
  pull_request:
    branches: [main]
    paths:
      - '.gitmodules'
      - 'Core/**'
      - '.github/workflows/secure-submodule-access.yml'
  workflow_dispatch:
    inputs:
      update_submodules:
        description: 'Update submodules to latest'
        required: false
        default: false
        type: boolean
      force_recursive:
        description: 'Force recursive submodule update'
        required: false
        default: false
        type: boolean

# Security: Minimal required permissions
permissions:
  contents: read
  actions: read
  pull-requests: write

env:
  NODE_VERSION: 20.x

jobs:
  validate-submodules:
    name: Validate Submodule Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has_submodules: ${{ steps.check.outputs.has_submodules }}
      submodule_count: ${{ steps.check.outputs.submodule_count }}
      pat_required: ${{ steps.check.outputs.pat_required }}

    steps:
      - name: Basic Repository Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          persist-credentials: false

      - name: Check Submodule Configuration
        id: check
        run: |
          echo "üîç Analyzing submodule configuration..."

          if [ -f ".gitmodules" ]; then
            echo "has_submodules=true" >> $GITHUB_OUTPUT
            SUBMODULE_COUNT=$(git config --file .gitmodules --get-regexp path | wc -l)
            echo "submodule_count=$SUBMODULE_COUNT" >> $GITHUB_OUTPUT
            echo "‚úÖ Found .gitmodules with $SUBMODULE_COUNT submodule(s)"

            # Check if submodules require private repository access
            echo "Submodule URLs:"
            git config --file .gitmodules --get-regexp url | while read -r key url; do
              echo "  - $url"
              if [[ "$url" == *"github.com"* ]] && [[ "$url" != *"public"* ]]; then
                echo "pat_required=true" >> $GITHUB_OUTPUT
              fi
            done

            # Default to requiring PAT for safety
            if [ ! -s $GITHUB_OUTPUT ] || ! grep -q "pat_required" $GITHUB_OUTPUT; then
              echo "pat_required=true" >> $GITHUB_OUTPUT
            fi

          else
            echo "has_submodules=false" >> $GITHUB_OUTPUT
            echo "submodule_count=0" >> $GITHUB_OUTPUT
            echo "pat_required=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No .gitmodules file found"
          fi

      - name: Display Submodule Information
        if: steps.check.outputs.has_submodules == 'true'
        run: |
          echo "üìã Submodule Configuration Summary:"
          echo "Number of submodules: ${{ steps.check.outputs.submodule_count }}"
          echo "PAT_TOKEN required: ${{ steps.check.outputs.pat_required }}"
          echo ""
          echo "Submodule details:"
          git config --file .gitmodules --list | grep -E "(path|url)" | sort

  secure-submodule-checkout:
    name: Secure Submodule Checkout
    runs-on: ubuntu-latest
    needs: validate-submodules
    if: needs.validate-submodules.outputs.has_submodules == 'true'
    timeout-minutes: 15

    # Security: Environment protection for submodule operations
    environment:
      name: submodule-access

    steps:
      - name: Validate PAT_TOKEN for Submodules
        id: validate-pat
        run: |
          if [ -z "${{ secrets.PAT_TOKEN }}" ]; then
            echo "pat_available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  PAT_TOKEN not configured - may affect private submodule access"
            echo "   Configure PAT_TOKEN in repository secrets for full functionality"
          else
            echo "pat_available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PAT_TOKEN available for submodule operations"
          fi

      - name: Checkout with Submodules (PAT_TOKEN)
        if: steps.validate-pat.outputs.pat_available == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          submodules: recursive
          fetch-depth: 1
          persist-credentials: false
        continue-on-error: true
        id: pat-submodule-checkout

      - name: Fallback Checkout with Submodules (GITHUB_TOKEN)
        if: steps.validate-pat.outputs.pat_available == 'false' || steps.pat-submodule-checkout.outcome == 'failure'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 1
          persist-credentials: false
        continue-on-error: true
        id: fallback-submodule-checkout

      - name: Manual Submodule Initialization (if needed)
        if: steps.pat-submodule-checkout.outcome == 'failure' && steps.fallback-submodule-checkout.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è  Automatic submodule checkout failed, attempting manual initialization..."

          # Try to initialize submodules manually
          git submodule init

          # Configure git with token if available
          if [ -n "${{ secrets.PAT_TOKEN }}" ]; then
            echo "Using PAT_TOKEN for manual submodule update..."
            # Configure git to use token (safely)
            git config --global credential.helper store
            echo "https://${{ secrets.PAT_TOKEN }}@github.com" > ~/.git-credentials
          fi

          # Attempt submodule update
          git submodule update --init --recursive --depth 1 || true

          # Clean up credentials
          rm -f ~/.git-credentials
          git config --global --unset credential.helper || true

      - name: Configure Git Security Settings
        run: |
          echo "üîß Configuring Git security settings..."

          # Security: Configure git with minimal required settings
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # Security: Set safe directory for all submodules
          git config --global --add safe.directory "*"

          # Security: Disable credential persistence
          git config --global credential.helper ""

          echo "‚úÖ Git security configuration completed"

      - name: Verify Submodule Access and Integrity
        run: |
          echo "üîç Verifying submodule access and integrity..."

          # Check submodule status
          echo "Submodule status:"
          git submodule status || echo "‚ö†Ô∏è  Unable to get submodule status"

          # Verify submodule directories exist and are populated
          echo ""
          echo "Submodule directory verification:"

          while IFS= read -r line; do
            if [[ $line =~ path[[:space:]]*=[[:space:]]*(.+) ]]; then
              submodule_path="${BASH_REMATCH[1]}"

              if [ -d "$submodule_path" ]; then
                file_count=$(find "$submodule_path" -type f 2>/dev/null | wc -l)
                if [ "$file_count" -gt 0 ]; then
                  echo "‚úÖ $submodule_path: $file_count files"
                else
                  echo "‚ö†Ô∏è  $submodule_path: directory exists but empty"
                fi
              else
                echo "‚ùå $submodule_path: directory not found"
              fi
            fi
          done < .gitmodules

          echo ""
          echo "Repository structure after submodule checkout:"
          find . -maxdepth 3 -type d | grep -E "(Core|modules?)" || echo "No obvious submodule directories found"

      - name: Submodule Security Scan
        run: |
          echo "üîç Performing submodule security scan..."

          # Check for sensitive files in submodules
          echo "Checking for sensitive files in submodules..."

          while IFS= read -r line; do
            if [[ $line =~ path[[:space:]]*=[[:space:]]*(.+) ]]; then
              submodule_path="${BASH_REMATCH[1]}"

              if [ -d "$submodule_path" ]; then
                echo "Scanning $submodule_path..."

                # Check for common sensitive files
                sensitive_files=$(find "$submodule_path" -name "*.env" -o -name "*.key" -o -name "*.pem" -o -name "*.p12" 2>/dev/null | head -5)

                if [ -n "$sensitive_files" ]; then
                  echo "‚ö†Ô∏è  Sensitive files found in $submodule_path:"
                  echo "$sensitive_files"
                else
                  echo "‚úÖ No sensitive files detected in $submodule_path"
                fi
              fi
            fi
          done < .gitmodules

      - name: Update Submodules (if requested)
        if: github.event.inputs.update_submodules == 'true'
        run: |
          echo "üîÑ Updating submodules to latest versions..."

          if [ "${{ github.event.inputs.force_recursive }}" = "true" ]; then
            echo "Performing recursive update..."
            git submodule update --remote --recursive || true
          else
            echo "Performing standard update..."
            git submodule update --remote || true
          fi

          echo "Submodule update completed"
          git submodule status

  submodule-testing:
    name: Submodule Functionality Testing
    runs-on: ubuntu-latest
    needs: [validate-submodules, secure-submodule-checkout]
    if: needs.validate-submodules.outputs.has_submodules == 'true' && needs.secure-submodule-checkout.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Re-checkout for Testing
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 1
          persist-credentials: false

      - name: Test Submodule Functionality
        run: |
          echo "üß™ Testing submodule functionality..."

          # Test each submodule
          while IFS= read -r line; do
            if [[ $line =~ path[[:space:]]*=[[:space:]]*(.+) ]]; then
              submodule_path="${BASH_REMATCH[1]}"

              if [ -d "$submodule_path" ]; then
                echo "Testing $submodule_path..."

                cd "$submodule_path"

                # Check git operations
                echo "  Git status: $(git status --porcelain | wc -l) changes"
                echo "  Latest commit: $(git log -1 --oneline 2>/dev/null || echo 'No commits')"
                echo "  Branch: $(git branch --show-current 2>/dev/null || echo 'detached HEAD')"

                # Test basic functionality if applicable
                if [ -f "package.json" ]; then
                  echo "  Node.js project detected"
                  if command -v npm >/dev/null 2>&1; then
                    echo "  Running npm install test..."
                    npm install --dry-run >/dev/null 2>&1 && echo "  ‚úÖ Dependencies resolvable" || echo "  ‚ö†Ô∏è  Dependency issues detected"
                  fi
                fi

                cd - >/dev/null
                echo "  ‚úÖ $submodule_path testing completed"
              else
                echo "  ‚ùå $submodule_path not accessible"
              fi
            fi
          done < .gitmodules

  security-monitoring:
    name: Submodule Security Monitoring
    runs-on: ubuntu-latest
    needs: [validate-submodules, secure-submodule-checkout, submodule-testing]
    if: always()
    timeout-minutes: 5

    permissions:
      security-events: write
      actions: read

    steps:
      - name: Generate Submodule Security Report
        run: |
          echo "üìä Generating submodule security report..."

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üîí Submodule Security Report

          ### Configuration Summary
          | Component | Status | Details |
          |-----------|--------|---------|
          | Submodules Present | ${{ needs.validate-submodules.outputs.has_submodules == 'true' && '‚úÖ Yes' || '‚ùå No' }} | ${{ needs.validate-submodules.outputs.submodule_count }} submodule(s) |
          | PAT_TOKEN Required | ${{ needs.validate-submodules.outputs.pat_required == 'true' && '‚úÖ Yes' || '‚ùå No' }} | Private repository access |
          | Checkout Success | ${{ needs.secure-submodule-checkout.result == 'success' && '‚úÖ Success' || needs.secure-submodule-checkout.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }} | Submodule initialization |
          | Functionality Test | ${{ needs.submodule-testing.result == 'success' && '‚úÖ Passed' || needs.submodule-testing.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }} | Operational verification |

          ### Security Measures
          - **Token Management**: PAT_TOKEN used securely ‚úÖ
          - **Credential Persistence**: Disabled ‚úÖ
          - **File Scanning**: Completed ‚úÖ
          - **Access Logging**: Comprehensive ‚úÖ

          ### Recommendations
          1. **Regular Updates**: Update submodules monthly
          2. **Security Scanning**: Scan submodule content for vulnerabilities
          3. **Access Review**: Audit submodule repository permissions
          4. **Backup Strategy**: Ensure submodule availability
          EOF

      - name: Log Submodule Events
        run: |
          echo "üìã Submodule security event logging:"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Workflow: ${{ github.workflow }}"
          echo "Repository: ${{ github.repository }}"
          echo "Submodules: ${{ needs.validate-submodules.outputs.submodule_count }}"
          echo "PAT Required: ${{ needs.validate-submodules.outputs.pat_required }}"
          echo "Checkout Result: ${{ needs.secure-submodule-checkout.result }}"
          echo "Testing Result: ${{ needs.submodule-testing.result }}"

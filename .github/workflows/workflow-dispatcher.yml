---
name: Intelligent Workflow Dispatcher

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

permissions:
  contents: read
  actions: write
  pull-requests: write

env:
  NODE_VERSION: '20'

jobs:
  analyze-changes:
    name: Analyze Changed Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      needs_frontend: ${{ steps.changes.outputs.frontend }}
      needs_backend: ${{ steps.changes.outputs.backend }}
      needs_web3: ${{ steps.changes.outputs.web3 }}
      needs_security: ${{ steps.changes.outputs.security }}
      needs_docs_only: ${{ steps.changes.outputs.docs_only }}
      needs_workflows: ${{ steps.changes.outputs.workflows }}
      needs_dependencies: ${{ steps.changes.outputs.dependencies }}
      needs_config: ${{ steps.changes.outputs.config }}
      changed_files: ${{ steps.changes.outputs.all_changed_files }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for accurate change detection

      - name: Detect changed files
        id: changes
        uses: dorny/paths-filter@v3
        with:
          list-files: json
          filters: |
            frontend:
              - 'GLX_App_files/src/**'
              - 'GLX_App_files/client/**'
              - 'GLX_App_files/components.json'
              - 'GLX_App_files/tailwind.config.js'
              - 'GLX_App_files/vite.config.js'
              - 'GLX_App_files/postcss.config.js'
              - 'GLX_App_files/index.html'
              - '!GLX_App_files/src/server/**'
              - '!GLX_App_files/server/**'

              
            backend:
              - 'GLX_App_files/server/**'
              - 'GLX_App_files/api/**'
              - 'GLX_App_files/tsconfig.server.json'
              - 'GLX_App_files/src/server/**'

              
            web3:
              - '**/*web3*'
              - '**/*crypto*'
              - '**/*blockchain*'
              - '**/*defi*'
              - 'GLX_App_files/server/middleware/web3-security.ts'
              - 'mcp-config.json'

            security:
              - 'GLX_App_files/server/**'
              - '.env*'
              - 'GLX_App_files/.env*'
              - 'package.json'
              - 'GLX_App_files/package.json'
              - 'package-lock.json'
              - 'GLX_App_files/package-lock.json'
              - '**/*auth*'
              - '**/*security*'
              - '**/*middleware*'

            workflows:
              - '.github/**'

            dependencies:
              - 'package.json'
              - 'GLX_App_files/package.json'
              - 'package-lock.json'
              - 'GLX_App_files/package-lock.json'
              - 'npm-shrinkwrap.json'
              - 'GLX_App_files/npm-shrinkwrap.json'

              
            config:
              - 'tsconfig.json'
              - 'GLX_App_files/tsconfig.json'
              - 'GLX_App_files/tsconfig.server.json'
              - 'GLX_App_files/vitest.config.js'
              - 'GLX_App_files/playwright.config.ts'
              - 'vercel.json'
              - '.lighthouserc.json'
              - 'GLX_App_files/.lighthouserc.json'

              
            docs_only:
              - '**/*.md'
              - 'docs/**'
              - '**/*.txt'
              - 'LICENSE'
              - 'NOTICE'
              - 'Legal/**'
              - 'screenshots/**'
              - 'whitepaper.md'

      - name: Determine workflow requirements
        id: requirements
        run: |
          echo "ğŸ” Analyzing changed files for intelligent workflow execution..."

          # Get all changed files
          ALL_FILES='${{ steps.changes.outputs.all_changed_files }}'
          echo "Changed files: $ALL_FILES"

          # Check if ONLY documentation files changed
          FRONTEND_CHANGED='${{ steps.changes.outputs.frontend }}'
          BACKEND_CHANGED='${{ steps.changes.outputs.backend }}'
          WEB3_CHANGED='${{ steps.changes.outputs.web3 }}'
          SECURITY_CHANGED='${{ steps.changes.outputs.security }}'
          WORKFLOWS_CHANGED='${{ steps.changes.outputs.workflows }}'
          DEPS_CHANGED='${{ steps.changes.outputs.dependencies }}'
          CONFIG_CHANGED='${{ steps.changes.outputs.config }}'
          DOCS_CHANGED='${{ steps.changes.outputs.docs_only }}'

          # Determine if this is a docs-only change
          if [[ "$DOCS_CHANGED" == "true" ]] && \
             [[ "$FRONTEND_CHANGED" == "false" ]] && \
             [[ "$BACKEND_CHANGED" == "false" ]] && \
             [[ "$WEB3_CHANGED" == "false" ]] && \
             [[ "$SECURITY_CHANGED" == "false" ]] && \
             [[ "$WORKFLOWS_CHANGED" == "false" ]] && \
             [[ "$DEPS_CHANGED" == "false" ]] && \
             [[ "$CONFIG_CHANGED" == "false" ]]; then
            echo "ğŸ“ Documentation-only changes detected"
            echo "docs_only=true" >> $GITHUB_OUTPUT
          else
            echo "docs_only=false" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ“Š Workflow Requirements Summary:"
          echo "  Frontend: $FRONTEND_CHANGED"
          echo "  Backend: $BACKEND_CHANGED"
          echo "  Web3: $WEB3_CHANGED"
          echo "  Security: $SECURITY_CHANGED"
          echo "  Workflows: $WORKFLOWS_CHANGED"
          echo "  Dependencies: $DEPS_CHANGED"
          echo "  Config: $CONFIG_CHANGED"
          echo "  Docs Only: $(if [[ "$DOCS_CHANGED" == "true" ]] && [[ "$FRONTEND_CHANGED" == "false" ]] && [[ "$BACKEND_CHANGED" == "false" ]] && [[ "$WEB3_CHANGED" == "false" ]] && [[ "$SECURITY_CHANGED" == "false" ]] && [[ "$WORKFLOWS_CHANGED" == "false" ]] && [[ "$DEPS_CHANGED" == "false" ]] && [[ "$CONFIG_CHANGED" == "false" ]]; then echo "true"; else echo "false"; fi)"

  trigger-comprehensive-checks:
    name: Trigger Comprehensive Checks
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: |
      needs.analyze-changes.outputs.needs_frontend == 'true' ||
      needs.analyze-changes.outputs.needs_backend == 'true' ||
      needs.analyze-changes.outputs.needs_config == 'true' ||
      needs.analyze-changes.outputs.needs_dependencies == 'true'
    steps:
      - name: Trigger Comprehensive CI/CD
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ—ï¸ Triggering comprehensive checks for code changes');
            console.log('Frontend changes:', '${{ needs.analyze-changes.outputs.needs_frontend }}');
            console.log('Backend changes:', '${{ needs.analyze-changes.outputs.needs_backend }}');
            console.log('Config changes:', '${{ needs.analyze-changes.outputs.needs_config }}');
            console.log('Dependency changes:', '${{ needs.analyze-changes.outputs.needs_dependencies }}');

  trigger-security-checks:
    name: Trigger Security Checks
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: |
      needs.analyze-changes.outputs.needs_security == 'true' ||
      needs.analyze-changes.outputs.needs_dependencies == 'true' ||
      needs.analyze-changes.outputs.needs_backend == 'true'
    steps:
      - name: Trigger Security Scans
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ”’ Triggering security checks for security-sensitive changes');
            console.log('Security changes:', '${{ needs.analyze-changes.outputs.needs_security }}');
            console.log('Dependency changes:', '${{ needs.analyze-changes.outputs.needs_dependencies }}');
            console.log('Backend changes:', '${{ needs.analyze-changes.outputs.needs_backend }}');

  trigger-web3-checks:
    name: Trigger Web3 Checks
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_web3 == 'true'
    steps:
      - name: Trigger Web3 Tests
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸŒ Triggering Web3 checks for blockchain/crypto changes');
            console.log('Web3 changes:', '${{ needs.analyze-changes.outputs.needs_web3 }}');

  docs-only-validation:
    name: Documentation-Only Validation
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.needs_docs_only == 'true'
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate documentation
        run: |
          echo "ğŸ“ Running lightweight validation for documentation-only changes"

          # Basic markdown validation
          echo "Checking for broken markdown links..."
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | while read file; do
            echo "Checking $file..."
            # Basic syntax check - just ensure the file is readable
            head -1 "$file" > /dev/null || echo "âš ï¸ Warning: $file may have issues"
          done

          echo "âœ… Documentation validation complete - no heavy CI/CD needed"

  workflow-summary:
    name: Workflow Dispatch Summary
    runs-on: ubuntu-latest
    needs: [analyze-changes, trigger-comprehensive-checks, trigger-security-checks, trigger-web3-checks, docs-only-validation]
    if: always()
    timeout-minutes: 2
    steps:
      - name: Summarize workflow decisions
        run: |
          echo "ğŸ¯ Intelligent Workflow Execution Summary"
          echo "========================================"
          echo ""
          echo "ğŸ“ Changed Files Analysis:"
          echo "  Frontend: ${{ needs.analyze-changes.outputs.needs_frontend }}"
          echo "  Backend: ${{ needs.analyze-changes.outputs.needs_backend }}"
          echo "  Web3: ${{ needs.analyze-changes.outputs.needs_web3 }}"
          echo "  Security: ${{ needs.analyze-changes.outputs.needs_security }}"
          echo "  Dependencies: ${{ needs.analyze-changes.outputs.needs_dependencies }}"
          echo "  Workflows: ${{ needs.analyze-changes.outputs.needs_workflows }}"
          echo "  Config: ${{ needs.analyze-changes.outputs.needs_config }}"
          echo "  Docs Only: ${{ needs.analyze-changes.outputs.needs_docs_only }}"
          echo ""
          echo "ğŸš€ Triggered Workflows:"
          echo "  Comprehensive CI/CD: ${{ needs.trigger-comprehensive-checks.result != 'skipped' }}"
          echo "  Security Scans: ${{ needs.trigger-security-checks.result != 'skipped' }}"
          echo "  Web3 Tests: ${{ needs.trigger-web3-checks.result != 'skipped' }}"
          echo "  Docs-Only Mode: ${{ needs.docs-only-validation.result != 'skipped' }}"
          echo ""

          if [[ "${{ needs.analyze-changes.outputs.needs_docs_only }}" == "true" ]]; then
            echo "âœ… Documentation-only changes detected - running lightweight validation"
            echo "âš¡ Estimated time saved: 15-25 minutes"
          else
            echo "ğŸ—ï¸ Code changes detected - running appropriate comprehensive checks"
          fi
